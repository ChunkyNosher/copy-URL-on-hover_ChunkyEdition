# .coderabbit.yaml
# Configuration for CodeRabbit AI Code Review
# yaml-language-server: $schema=https://coderabbit.ai/integrations/schema.v2.json

# Language and tone
language: en-US
tone_instructions: 'Focus on logic correctness, security issues, and browser extension best practices. Be concise but thorough.'

reviews:
  # Review profile (assertive = detailed feedback)
  profile: assertive

  # Auto-review configuration
  auto_review:
    enabled: true
    drafts: false
    
    # Enable review for all branches including bot-created ones
    base_branches:
      - main
      - develop
      - 'deepsource-transform-*'  # DeepSource autofix branches
      - 'copilot/**'  # Copilot Agent branches

    # CRITICAL: Empty list means review ALL PRs including bots
    # This fixes the "Bot user detected, review skipped" issue
    ignore_usernames: []

  # Show high-level summary of changes
  high_level_summary: true
  high_level_summary_in_walkthrough: true

  # Hide the "Review skipped" message for cleaner PRs
  # Set to true if you want to see when reviews are skipped
  review_status: false

  # Path-specific instructions
  path_instructions:
    - path: 'background.js'
      instructions: |
        This is a browser extension background script. Pay attention to:
        - Message passing security (validate sender origins)
        - Async error handling in storage operations
        - Container isolation logic (cookieStoreId checks)
        - Storage quota management (100KB limit for sync)

    - path: 'state-manager.js'
      instructions: |
        State management module. Check for:
        - Race conditions in async operations
        - Proper container isolation
        - Memory leaks (WeakMap usage)
        - Error propagation

    - path: '**/*.test.js'
      instructions: |
        Test files. Verify:
        - Edge cases are covered
        - Error scenarios are tested
        - Mocks are properly set up
        - Coverage is comprehensive

    - path: 'manifest.json'
      instructions: |
        Extension manifest. Ensure:
        - Manifest V2 compliance (required for webRequestBlocking)
        - Minimal required permissions
        - CSP is properly configured
        - Browser-specific settings are correct

  # Review tools integration
  tools:
    # ESLint integration
    eslint:
      enabled: true

    # Secret detection
    gitleaks:
      enabled: true

# Chat configuration
chat:
  # Auto-reply to questions without requiring @mention
  auto_reply: true

# Knowledge base - helps CodeRabbit learn from your docs
knowledge_base:
  opt_out: false
  code_guidelines:
    enabled: true
    filePatterns:
      - '**/.github/copilot-instructions.md'
      - '**/README.md'
      - '**/docs/**/*.md'
