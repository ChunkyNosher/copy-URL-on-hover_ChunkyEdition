# v1.6.0 Refactoring Phase 2.11 Next Steps

**Created:** 2025-11-19 | **Session:** 5 | **Status:** Phase 2.10 at 40% (2/5 components done)

## Quick Summary

Extract 3 remaining panel components (PanelResizeController, PanelStateManager, PanelContentManager), then refactor panel.js to facade. Target: 1497 → 300 lines (-80%).

**Done:** PanelUIBuilder ✅, PanelDragController ✅  
**Remaining:** 3 components + facade + integration tests + checklist update

---

## Component 3: PanelResizeController (NEXT)

**Extract from:** `panel.js` method `makePanelResizable()` (lines 960-1096)  
**File:** `src/features/quick-tabs/panel/PanelResizeController.js` (~200 lines)  
**Tests:** `tests/unit/panel/PanelResizeController.test.js` (~25 tests)

**Key Requirements:**
- Table-driven config for 8 directions (n/s/e/w/ne/nw/se/sw) like window/ResizeHandle.js
- Pointer Events API: pointerdown/move/up/cancel with setPointerCapture()
- Min constraints: 250px width, 300px height
- Callbacks: onSizeChange, onPositionChange, onResizeEnd, onBroadcast
- Broadcast size+position on resize end (v1.5.9.8 fix)
- destroy() method for cleanup

**Tests:** Handle creation, resize calcs, min constraints, pointer capture, callbacks, cleanup (25 tests, 100% coverage)

---

## Component 4: PanelStateManager

**Extract from:** `panel.js` methods detectContainerContext (430-451), setupBroadcastChannel (457-528), loadPanelState (596-630), savePanelState (631-635), savePanelStateLocal (636-650)  
**File:** `src/features/quick-tabs/panel/PanelStateManager.js` (~200 lines)  
**Tests:** `tests/unit/panel/PanelStateManager.test.js` (~18 tests)

**Key Requirements:**
- Container detection via browser.tabs.query() → cookieStoreId (default 'firefox-default')
- BroadcastChannel 'quick-tabs-panel-sync': Handle OPENED/CLOSED/POSITION_UPDATED/SIZE_UPDATED
- 50ms debounce on broadcasts (v1.5.9.8 fix prevents infinite loops)
- Storage: browser.storage.local key 'quick_tabs_panel_state' (left/top/width/height)
- savePanelStateLocal() updates local state WITHOUT storage write
- Callbacks: onStateLoaded, onBroadcastReceived
- destroy() cleanup

**Tests:** Container detection, broadcast routing, debouncing, load/save, local-only save, cleanup (18 tests, 100% coverage)

---

## Component 5: PanelContentManager

**Extract from:** `panel.js` methods updatePanelContent (1104-1186, cc=16), closeMinimizedQuickTabs (1348-1402), closeAllQuickTabs (1405-1444), goToTab/minimizeQuickTab/restoreQuickTab/closeQuickTab (1447-1497)  
**File:** `src/features/quick-tabs/panel/PanelContentManager.js` (~300 lines)  
**Tests:** `tests/unit/panel/PanelContentManager.test.js` (~20 tests)

**Key Requirements:**
- updatePanelContent decomposition: Extract 5 helpers (_loadQuickTabsState, _filterByContainer, _loadContainerInfo, _updateStats, _showEmptyState) to reduce cc=16 → cc≤5
- Support 3 storage formats: v1.5.8.15 wrapped, v1.5.8.14 unwrapped, legacy
- Container filtering: Only show tabs matching current cookieStoreId (v1.5.9.12)
- Quick Tab ops: Send runtime messages (MINIMIZE/RESTORE/CLOSE_QUICK_TAB) or browser.tabs.update for goToTab
- Batch ops: closeMinimizedQuickTabs filters + sends CLOSE for each; closeAllQuickTabs sends CLOSE for all

**Tests:** 3 format types, container filtering, empty state, 7 operations, message sending, stats (20 tests, 100% coverage)

---

## Component 6: panel.js Facade Refactor

**Refactor:** `src/features/quick-tabs/panel.js` IN PLACE (1497 → ~300 lines)  
**Tests:** `tests/integration/panel/PanelManager.test.js` (~15 integration tests)

**Orchestration Sequence:**
1. Import 5 components
2. Constructor: Initialize component instances
3. init(): stateManager.init() → loadState → PanelUIBuilder.injectStyles/createPanel → initialize dragController/resizeController/contentManager → setupListeners → appendToDocument
4. Delegate: toggle/open/close/openSilent/closeSilent to components
5. setupPanelEventListeners: Route button clicks to contentManager methods
6. Delete: makePanelDraggable/Resizable, detectContainerContext, setupBroadcastChannel, load/savePanelState, updatePanelContent, all Quick Tab ops, PANEL_HTML/CSS constants
7. Keep: constructor, init, toggle, open/close, openSilent/closeSilent, setupMessageListener, setupPanelEventListeners, _handleBroadcast

**Integration Tests:** Init, open/close, drag/resize, content updates, Quick Tab ops, broadcast sync, container isolation, cleanup, multi-component coordination, error handling (15 tests, 705 total passing)

---

## Workflow Per Component

1. Read source (panel.js at specified lines)
2. Create component file in `src/features/quick-tabs/panel/`
3. Write tests in `tests/unit/panel/` (TDD approach)
4. Run tests: `npm test -- tests/unit/panel/[Name].test.js`
5. Run ESLint: `npx eslint src/features/quick-tabs/panel/[Name].js` (0 errors required)
6. Use report_progress after completion
7. Update master checklist

**Facade Workflow:** Import 5 components → Refactor constructor/init → Delegate operations → Delete extracted code → Write 15 integration tests → Run `npm test` (705 passing) → Run ESLint on panel.js (0 errors) → Verify ~300 lines → Commit

---

## Quality Gates & Success Criteria

**Per-Component:** cc≤9, max-depth≤2, max-lines≤70, 0 ESLint errors, 100% coverage  
**Overall:** panel.js 1497→300 lines, 641→705 tests, -5 errors/-4 warnings from panel.js

**Phase 2.10 Complete When:**
- [ ] PanelResizeController: 25 tests, 100% coverage
- [ ] PanelStateManager: 18 tests, 100% coverage
- [ ] PanelContentManager: 20 tests, 100% coverage
- [ ] panel.js facade: ~300 lines
- [ ] Integration tests: 15 tests
- [ ] All 705 tests passing
- [ ] Master checklist updated

---

## Key Patterns (Perplexity-Validated)

1. **Pointer Events:** setPointerCapture() on pointerdown prevents resize interruptions
2. **Storage Adapter:** Async-first Promise-based design for browser.storage
3. **BroadcastChannel:** 50ms debounce prevents infinite loops
4. **Container-Aware:** Use cookieStoreId for Firefox Container isolation
5. **Facade:** Event-driven coordination of 5 components, single entry point

---

## Skip These

❌ PanelUIBuilder (done) | ❌ PanelDragController (done) | ⏸️ Optional WindowStyler/Factory | ⏸️ Phase 3/4

**Focus:** ResizeController → StateManager → ContentManager → Facade → Integration Tests → Checklist

---

**Time:** 6-10 hours | **Next Phase:** Background Script Refactor (Phase 3) or Content Script Refactor (Phase 4)
