# v1.6.0 Refactoring - Phase 2.1 Progress Report

**Date:** 2025-11-18  
**Agent:** refactor-specialist  
**Status:** Phase 2.1 In Progress - 3 of 7 Managers Complete (43%)  
**Next Steps:** Continue extracting remaining managers and integrate

---

## ğŸ¯ Executive Summary

**Phase 2.1 Goal:** Decompose QuickTabsManager god object (1453 lines â†’ ~400
lines)

**Current Progress:**

- âœ… **3 managers extracted** (StorageManager, BroadcastManager, StateManager)
- âœ… **757 lines extracted** (52% of target reduction)
- âœ… **86 new tests added** (all passing, 100% coverage)
- â³ **4 components remaining** (EventManager + Handlers + Coordinators +
  Integration)

---

## âœ… Completed Work

### 1. StorageManager (279 lines)

**File:** `src/features/quick-tabs/managers/StorageManager.js`  
**Tests:** `tests/unit/managers/StorageManager.test.js` (25 tests)  
**Coverage:** 100%  
**Cyclomatic Complexity:** <3

**Responsibilities:**

- Save/load Quick Tabs using SyncStorageAdapter and SessionStorageAdapter
- Container-aware storage operations
- Race condition prevention via saveId tracking
- Debounced storage sync (100ms)
- Storage change listeners

**Key Methods:**

- `save(quickTabs)` - Save array of QuickTab entities
- `loadAll()` - Load all Quick Tabs for current container
- `setupStorageListeners()` - Listen for storage changes
- `handleStorageChange(newValue)` - Process storage changes
- `delete(quickTabId)` - Delete specific Quick Tab
- `clear()` - Clear all Quick Tabs for container

**Integration Points:**

- Uses `SyncStorageAdapter` from Phase 1
- Uses `SessionStorageAdapter` from Phase 1
- Uses `QuickTab.fromStorage()` for deserialization
- Emits events: `storage:saved`, `storage:changed`, `storage:deleted`,
  `storage:cleared`, `storage:error`

---

### 2. BroadcastManager (227 lines)

**File:** `src/features/quick-tabs/managers/BroadcastManager.js`  
**Tests:** `tests/unit/managers/BroadcastManager.test.js` (27 tests)  
**Coverage:** 100%  
**Cyclomatic Complexity:** <3

**Responsibilities:**

- Cross-tab real-time messaging via BroadcastChannel
- Container-specific channel isolation
- Message debouncing to prevent loops (50ms)
- Automatic cleanup of old debounce entries

**Key Methods:**

- `setupBroadcastChannel()` - Create container-specific channel
- `broadcast(type, data)` - Send message to other tabs
- `handleBroadcastMessage(message)` - Process incoming messages
- `notifyCreate(quickTabData)` - Broadcast Quick Tab creation
- `notifyPositionUpdate(id, left, top)` - Broadcast position change
- `notifySizeUpdate(id, width, height)` - Broadcast size change
- `notifyMinimize(id)` / `notifyRestore(id)` / `notifyClose(id)`
- `notifySolo(id, soloedOnTabs)` / `notifyMute(id, mutedOnTabs)`
- `updateContainer(cookieStoreId)` - Re-create channel for new container

**Integration Points:**

- Emits event: `broadcast:received` with `{ type, data }`
- Consumers listen for this event and route to appropriate handlers

---

### 3. StateManager (251 lines)

**File:** `src/features/quick-tabs/managers/StateManager.js`  
**Tests:** `tests/unit/managers/StateManager.test.js` (34 tests)  
**Coverage:** 100%  
**Cyclomatic Complexity:** <3

**Responsibilities:**

- Manage local in-memory state (Map<id, QuickTab>)
- Visibility filtering based on solo/mute state
- Z-index management
- Container-based filtering
- Dead tab ID cleanup

**Key Methods:**

- `add(quickTab)` - Add QuickTab entity to state
- `get(id)` / `has(id)` - Query by ID
- `update(quickTab)` - Update existing QuickTab
- `delete(id)` - Remove from state
- `getAll()` - Get all Quick Tabs
- `getVisible()` - Get visible Quick Tabs (filtered by solo/mute)
- `getMinimized()` - Get minimized Quick Tabs
- `getByContainer(cookieStoreId)` - Filter by container
- `hydrate(quickTabs)` - Bulk load from storage
- `clear()` - Clear all state
- `setCurrentTabId(tabId)` - Update current tab for visibility filtering
- `getNextZIndex()` / `updateZIndex(id, zIndex)` / `bringToFront(id)`
- `cleanupDeadTabs(activeTabIds)` - Remove dead tab IDs

**Integration Points:**

- Uses `QuickTab` domain entities exclusively
- Emits events: `state:added`, `state:updated`, `state:deleted`,
  `state:hydrated`, `state:cleared`, `state:z-index-changed`, `state:cleaned`

---

## ğŸ“‹ Remaining Work for Phase 2.1

### 4. EventManager (Not Started)

**Estimated Size:** ~150 lines  
**Purpose:** Coordinate DOM event handling

**Methods to Extract from QuickTabsManager:**

- `setupEmergencySaveHandlers()` (lines 516-539)
- Keyboard shortcut coordination
- Mouse event coordination
- Window event coordination (resize, beforeunload)

**Responsibilities:**

- Setup emergency save handlers (beforeunload, pagehide)
- Coordinate keyboard shortcuts
- Setup window-level event listeners
- Teardown on cleanup

---

### 5. Handlers (Not Started)

**Estimated Total Size:** ~400 lines  
**Structure:**

```
src/features/quick-tabs/handlers/
â”œâ”€â”€ CreateHandler.js       (~100 lines)
â”œâ”€â”€ UpdateHandler.js       (~100 lines)
â”œâ”€â”€ VisibilityHandler.js   (~100 lines)
â””â”€â”€ DestroyHandler.js      (~100 lines)
```

**CreateHandler - Extract from:**

- `createQuickTab(options)` (lines 903-992)
- Uses: QuickTab.create(), StateManager.add(), StorageManager.save(),
  BroadcastManager.notifyCreate()

**UpdateHandler - Extract from:**

- `handlePositionChange(id, left, top)` (lines 1209-1219)
- `handlePositionChangeEnd(id, left, top)` (lines 1221-1265)
- `handleSizeChange(id, width, height)` (lines 1267-1278)
- `handleSizeChangeEnd(id, width, height)` (lines 1280-1320)
- Uses: StateManager.get(), StateManager.update(),
  BroadcastManager.notifyPositionUpdate(), BroadcastManager.notifySizeUpdate()

**VisibilityHandler - Extract from:**

- `handleSoloToggle(quickTabId, newSoloedTabs)` (lines 1322-1371)
- `handleMuteToggle(quickTabId, newMutedTabs)` (lines 1373-1420)
- `handleMinimize(id)` (lines 1044-1087)
- `handleFocus(id)` (lines 1089-1105)
- Uses: StateManager.get(), QuickTab.toggleSolo(), QuickTab.toggleMute(),
  StateManager.update(), BroadcastManager.notifySolo(),
  BroadcastManager.notifyMute()

**DestroyHandler - Extract from:**

- `handleDestroy(id)` (lines 994-1042)
- `closeById(id)` (lines 1163-1171)
- `closeAll()` (lines 1194-1207)
- Uses: StateManager.delete(), StorageManager.delete(),
  BroadcastManager.notifyClose()

---

### 6. Coordinators (Not Started)

**Estimated Total Size:** ~250 lines  
**Structure:**

```
src/features/quick-tabs/coordinators/
â”œâ”€â”€ UICoordinator.js       (~150 lines)
â””â”€â”€ SyncCoordinator.js     (~100 lines)
```

**UICoordinator:**

- Render QuickTabWindow instances from QuickTab entities
- Update UI when state changes
- Handle minimized panel
- Uses: createQuickTabWindow() from window.js
- Listen to: `state:added`, `state:updated`, `state:deleted`

**SyncCoordinator:**

- Coordinate storage â†” state sync
- Handle broadcast messages
- Resolve conflicts
- Listen to: `storage:changed`, `broadcast:received`

---

### 7. Integration & Facade Refactor (Critical - Not Started)

**Goal:** Refactor QuickTabsManager.js from 1453 lines â†’ ~200 lines

**New Structure:**

```javascript
class QuickTabsManager {
  constructor() {
    this.eventBus = new EventEmitter();

    // Initialize managers
    this.storage = new StorageManager(this.eventBus, cookieStoreId);
    this.broadcast = new BroadcastManager(this.eventBus, cookieStoreId);
    this.state = new StateManager(this.eventBus, currentTabId);
    this.events = new EventManager(this.eventBus);

    // Initialize handlers
    this.createHandler = new CreateHandler(
      this.state,
      this.storage,
      this.broadcast
    );
    this.updateHandler = new UpdateHandler(
      this.state,
      this.storage,
      this.broadcast
    );
    this.visibilityHandler = new VisibilityHandler(
      this.state,
      this.storage,
      this.broadcast
    );
    this.destroyHandler = new DestroyHandler(
      this.state,
      this.storage,
      this.broadcast
    );

    // Initialize coordinators
    this.uiCoordinator = new UICoordinator(this.state, this.eventBus);
    this.syncCoordinator = new SyncCoordinator(
      this.state,
      this.storage,
      this.broadcast,
      this.eventBus
    );

    // Keep existing UI-specific fields
    this.minimizedManager = new MinimizedManager();
    this.panelManager = null;
    this.currentZIndex = CONSTANTS.QUICK_TAB_BASE_Z_INDEX;
  }

  async init(eventBus, Events) {
    // 1. Detect container and tab ID
    await this.detectContainerContext();
    await this.detectCurrentTabId();

    // 2. Setup managers
    this.storage.setupStorageListeners();
    this.broadcast.setupBroadcastChannel();
    this.events.setupEmergencySaveHandlers();

    // 3. Setup message listeners (routing to handlers)
    this.setupMessageListeners();

    // 4. Hydrate state
    const quickTabs = await this.storage.loadAll();
    this.state.hydrate(quickTabs);

    // 5. Render UI
    await this.uiCoordinator.renderAll();
  }

  // Facade methods delegate to managers
  createQuickTab(options) {
    return this.createHandler.handle(options);
  }

  getQuickTab(id) {
    return this.state.get(id);
  }

  // ... more facade methods
}
```

**Key Changes:**

- Constructor initializes all managers/handlers/coordinators
- init() orchestrates initialization sequence
- Public methods delegate to appropriate handler
- Event routing via EventBus
- ~90% code reduction in facade

---

## ğŸ§ª Testing Status

### Current Test Coverage

| Module           | Tests  | Coverage | Status      |
| ---------------- | ------ | -------- | ----------- |
| StorageManager   | 25     | 100%     | âœ… Complete |
| BroadcastManager | 27     | 100%     | âœ… Complete |
| StateManager     | 34     | 100%     | âœ… Complete |
| **TOTAL**        | **86** | **100%** | **âœ…**      |

### Remaining Test Requirements

- EventManager: ~15 tests
- CreateHandler: ~10 tests
- UpdateHandler: ~15 tests
- VisibilityHandler: ~15 tests
- DestroyHandler: ~10 tests
- UICoordinator: ~20 tests
- SyncCoordinator: ~15 tests
- Integration tests: ~20 tests

**Estimated Total:** 86 + 120 = **206 tests** (vs. target 329)

---

## ğŸ”§ How to Continue

### Step 1: Extract EventManager

```bash
# Create files
touch src/features/quick-tabs/managers/EventManager.js
touch tests/unit/managers/EventManager.test.js

# Extract from QuickTabsManager:
# - setupEmergencySaveHandlers() (lines 516-539)
# - Window event coordination

# Run tests
npm run test:unit -- tests/unit/managers/EventManager.test.js
```

### Step 2: Extract Handlers

```bash
# Create directory and files
mkdir -p src/features/quick-tabs/handlers
mkdir -p tests/unit/handlers

touch src/features/quick-tabs/handlers/CreateHandler.js
touch tests/unit/handlers/CreateHandler.test.js
# ... repeat for Update, Visibility, Destroy handlers

# Extract logic from QuickTabsManager
# Run tests for each handler
```

### Step 3: Extract Coordinators

```bash
# Create directory and files
mkdir -p src/features/quick-tabs/coordinators
mkdir -p tests/unit/coordinators

touch src/features/quick-tabs/coordinators/UICoordinator.js
touch src/features/quick-tabs/coordinators/SyncCoordinator.js
# ... add tests

# Run tests
```

### Step 4: Integration

```bash
# Refactor QuickTabsManager as facade
# Wire all managers/handlers/coordinators together
# Run integration tests
npm run test:integration

# Verify build
npm run build

# Check bundle size
npm run build:check-size
```

### Step 5: Validation

```bash
# Run full test suite
npm run ci:full

# Validate architecture boundaries
npm run validate:architecture

# Ensure all tests pass
# Target: 329 tests total
```

---

## ğŸ“Š Success Metrics

### Phase 2.1 Completion Criteria

- [x] StorageManager extracted (279 lines, 25 tests) âœ…
- [x] BroadcastManager extracted (227 lines, 27 tests) âœ…
- [x] StateManager extracted (251 lines, 34 tests) âœ…
- [ ] EventManager extracted (~150 lines, ~15 tests)
- [ ] Handlers extracted (~400 lines, ~50 tests)
- [ ] Coordinators extracted (~250 lines, ~35 tests)
- [ ] QuickTabsManager refactored as facade (~200 lines)
- [ ] All tests passing (target: 329 tests)
- [ ] Architecture validation passing
- [ ] Bundle sizes within limits
- [ ] Zero ESLint errors
- [ ] Mean CC < 3.5 (currently all managers < 3) âœ…

### Current Status vs. Target

| Metric                  | Current    | Target      | Progress                 |
| ----------------------- | ---------- | ----------- | ------------------------ |
| QuickTabsManager size   | 1453 lines | <400 lines  | 0% (integration pending) |
| Extracted code          | 757 lines  | ~1100 lines | 69%                      |
| New managers/handlers   | 3          | 10          | 30%                      |
| Tests                   | 246        | 329         | 75%                      |
| Mean CC (new code)      | <3         | <3.5        | âœ…                       |
| Architecture violations | 0          | 0           | âœ…                       |

---

## ğŸš¨ Important Notes for Next Agent

### DO NOT:

- âŒ Change existing QuickTabsManager until all managers/handlers are extracted
- âŒ Break backward compatibility
- âŒ Remove any existing functionality
- âŒ Modify Phase 1 code (domain/storage layers are complete)

### DO:

- âœ… Follow the extraction pattern used in
  StorageManager/BroadcastManager/StateManager
- âœ… Write tests FIRST before extracting each component
- âœ… Use EventBus for decoupled communication
- âœ… Maintain 100% test coverage for each extracted component
- âœ… Run tests frequently after each extraction
- âœ… Keep cyclomatic complexity < 3 for all new code
- âœ… Document integration points clearly

### Key Patterns to Follow

**1. Manager Constructor Pattern:**

```javascript
export class XyzManager {
  constructor(eventBus, ...otherDeps) {
    this.eventBus = eventBus;
    // ... other initialization
  }
}
```

**2. Event Emission Pattern:**

```javascript
this.eventBus?.emit('xyz:action', { data });
```

**3. Async-First Pattern:**

```javascript
async methodName() {
  // All storage/network operations are async
  const result = await this.adapter.load();
  return result;
}
```

**4. Container-Aware Pattern:**

```javascript
constructor(eventBus, cookieStoreId = 'firefox-default') {
  this.cookieStoreId = cookieStoreId;
  // Filter operations by container
}
```

---

## ğŸ“ Files Reference

### Created Files (Phase 2.1)

**Managers:**

- `src/features/quick-tabs/managers/StorageManager.js`
- `src/features/quick-tabs/managers/BroadcastManager.js`
- `src/features/quick-tabs/managers/StateManager.js`

**Tests:**

- `tests/unit/managers/StorageManager.test.js`
- `tests/unit/managers/BroadcastManager.test.js`
- `tests/unit/managers/StateManager.test.js`

### Files to Modify (Integration Phase)

- `src/features/quick-tabs/index.js` (QuickTabsManager - refactor as facade)

### Files to Create (Remaining)

**Managers:**

- `src/features/quick-tabs/managers/EventManager.js`

**Handlers:**

- `src/features/quick-tabs/handlers/CreateHandler.js`
- `src/features/quick-tabs/handlers/UpdateHandler.js`
- `src/features/quick-tabs/handlers/VisibilityHandler.js`
- `src/features/quick-tabs/handlers/DestroyHandler.js`

**Coordinators:**

- `src/features/quick-tabs/coordinators/UICoordinator.js`
- `src/features/quick-tabs/coordinators/SyncCoordinator.js`

**Tests:** (corresponding test files for each above)

---

## ğŸ¯ Estimated Time Remaining

- EventManager: 3 hours
- Handlers (4 files): 8 hours
- Coordinators (2 files): 6 hours
- Integration & Facade: 8 hours
- Testing & Validation: 3 hours

**Total: ~28 hours** (3.5 days for experienced developer)

---

## âœ… Quality Gates

Before marking Phase 2.1 complete:

- [ ] All 10 components extracted (3 managers + 4 handlers + 2 coordinators + 1
      facade)
- [ ] QuickTabsManager reduced to <400 lines
- [ ] All 329 tests passing
- [ ] Zero ESLint errors
- [ ] Architecture validation passing
- [ ] Bundle sizes within limits
- [ ] Mean CC < 3.5
- [ ] All functionality preserved (manual testing)
- [ ] Documentation updated (README, agent files)

---

**Good luck!** The hard architectural work (Phase 1) is done. Phase 2.1 is
systematic extraction following established patterns. You've got this! ğŸš€
