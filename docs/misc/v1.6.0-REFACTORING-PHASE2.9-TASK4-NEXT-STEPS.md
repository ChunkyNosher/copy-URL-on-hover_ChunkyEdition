# Phase 2.9 Task 4: Extract TitlebarBuilder Component - Next Steps

**Date:** 2025-11-19  
**Phase:** 2.9 (Window Component Integration)  
**Task:** 4 - Extract TitlebarBuilder Component  
**Status:** Ready to Start  
**Priority:** HIGH - Eliminates max-lines-per-function warning in window.js

---

## Context: What Was Just Completed (Task 3)

### Phase 2.9 Task 3: DragController Integration âœ… COMPLETE

**What Was Done:**
- âœ… Migrated DragController from Mouse Events to Pointer Events API
- âœ… Added pointercancel handler for Issue #51 fix (tab switch during drag)
- âœ… Integrated DragController into window.js render() method
- âœ… Replaced setupDragHandlers() method (~50 lines) with facade
- âœ… Added PointerEvent polyfill to tests/setup.js
- âœ… Rewrote all 19 DragController tests for Pointer Events
- âœ… Updated master checklist

**Current State:**
- Tests: 541/541 passing (539 + 2 skipped) âœ…
- Build: Successful âœ…
- ESLint: 58 errors (+1), 25 warnings (+4)
- window.js: 879 lines, 2 ESLint warnings (render + createTitlebar too long)
- Phase 2.9 Progress: 60% complete

**Files Changed:**
- `src/features/quick-tabs/window/DragController.js` - Updated to Pointer Events API
- `src/features/quick-tabs/window.js` - Integrated DragController
- `tests/setup.js` - Added PointerEvent polyfill
- `tests/unit/window/DragController.test.js` - Rewrote for Pointer Events

---

## Task 4 Objective: Extract TitlebarBuilder Component

### Goal

Extract the `createTitlebar()` method (157 lines, cc unknown) from `window.js` into a dedicated `TitlebarBuilder.js` class following the facade pattern used for ResizeController and DragController.

### Why This Matters

1. **Reduces window.js complexity** - Eliminates 157 lines from window.js
2. **Fixes ESLint warning** - `createTitlebar()` has max-lines-per-function violation
3. **Improves reusability** - Titlebar logic can be tested and reused independently
4. **Follows established pattern** - Matches ResizeController/DragController approach
5. **Enables future enhancements** - Easier to add themes, custom buttons, etc.

### Current Implementation Location

**File:** `src/features/quick-tabs/window.js`  
**Method:** `createTitlebar()` starting at line ~219  
**Lines:** 157 lines (exceeds 70-line limit)  
**Dependencies:**
- `createElement()` from `../../utils/dom.js`
- Solo/mute button handlers
- Navigation buttons (back/forward/reload)
- Close/minimize buttons
- Favicon display
- Title display

---

## Implementation Strategy

### Step 1: Analyze Current Implementation

**Read the createTitlebar() method completely:**
```bash
# View the method
view src/features/quick-tabs/window.js 219 376
```

**Identify key components:**
1. Titlebar container creation
2. Left section (navigation + favicon + title)
3. Navigation buttons (back/forward/reload)
4. Favicon loading
5. Title text display
6. Right section (solo/mute/minimize/close buttons)
7. Button event handlers

### Step 2: Design TitlebarBuilder Interface

**Create:** `src/features/quick-tabs/window/TitlebarBuilder.js`

**Proposed Interface:**
```javascript
export class TitlebarBuilder {
  /**
   * @param {Object} config - Configuration options
   * @param {string} config.title - Initial title text
   * @param {string} config.url - URL for favicon extraction
   * @param {Array<number>} config.soloedOnTabs - Solo tab IDs
   * @param {Array<number>} config.mutedOnTabs - Mute tab IDs
   * @param {Object} callbacks - Event callbacks
   * @param {Function} callbacks.onClose - Close button clicked
   * @param {Function} callbacks.onMinimize - Minimize button clicked
   * @param {Function} callbacks.onSolo - Solo button clicked
   * @param {Function} callbacks.onMute - Mute button clicked
   * @param {Function} callbacks.onNavigateBack - Back button clicked
   * @param {Function} callbacks.onNavigateForward - Forward button clicked
   * @param {Function} callbacks.onNavigateReload - Reload button clicked
   */
  constructor(config, callbacks) {
    this.config = config;
    this.callbacks = callbacks;
    
    // DOM element references
    this.titlebar = null;
    this.titleElement = null;
    this.soloButton = null;
    this.muteButton = null;
    this.faviconElement = null;
  }

  /**
   * Build and return the titlebar element
   * @returns {HTMLElement} The titlebar DOM element
   */
  build() {
    this.titlebar = this._createContainer();
    this.titlebar.appendChild(this._createLeftSection());
    this.titlebar.appendChild(this._createRightSection());
    return this.titlebar;
  }

  /**
   * Update title text
   * @param {string} newTitle - New title
   */
  updateTitle(newTitle) {
    if (this.titleElement) {
      this.titleElement.textContent = newTitle;
    }
  }

  /**
   * Update solo button state
   * @param {boolean} isSoloed - Whether currently soloed
   */
  updateSoloButton(isSoloed) {
    if (this.soloButton) {
      this.soloButton.textContent = isSoloed ? 'ðŸŽ¯' : 'â­•';
      this.soloButton.title = isSoloed ? 'Unsolo' : 'Solo';
    }
  }

  /**
   * Update mute button state
   * @param {boolean} isMuted - Whether currently muted
   */
  updateMuteButton(isMuted) {
    if (this.muteButton) {
      this.muteButton.textContent = isMuted ? 'ðŸ”‡' : 'ðŸ”Š';
      this.muteButton.title = isMuted ? 'Unmute' : 'Mute';
    }
  }

  // Private helper methods
  _createContainer() { /* ... */ }
  _createLeftSection() { /* ... */ }
  _createRightSection() { /* ... */ }
  _createNavigationButtons() { /* ... */ }
  _createFavicon() { /* ... */ }
  _createTitle() { /* ... */ }
  _createButton(text, title, onClick) { /* ... */ }
}
```

### Step 3: Extract Method Logic

**Copy createTitlebar() logic** into TitlebarBuilder methods:

1. **Container creation** â†’ `_createContainer()`
2. **Left section** â†’ `_createLeftSection()`
   - Navigation buttons â†’ `_createNavigationButtons()`
   - Favicon â†’ `_createFavicon()`
   - Title â†’ `_createTitle()`
3. **Right section** â†’ `_createRightSection()`
   - Solo button â†’ `_createButton()` with solo handler
   - Mute button â†’ `_createButton()` with mute handler
   - Minimize button â†’ `_createButton()` with minimize handler
   - Close button â†’ `_createButton()` with close handler

**Preserve all styling and behavior exactly as-is.**

### Step 4: Integrate into window.js

**Replace in render() method:**

**Before:**
```javascript
// Create titlebar
const titlebar = this.createTitlebar();
this.container.appendChild(titlebar);
```

**After:**
```javascript
// v1.6.0 Phase 2.9 Task 4 - Use TitlebarBuilder facade pattern
this.titlebarBuilder = new TitlebarBuilder(
  {
    title: this.title,
    url: this.url,
    soloedOnTabs: this.soloedOnTabs,
    mutedOnTabs: this.mutedOnTabs
  },
  {
    onClose: () => this.destroy(),
    onMinimize: () => this.minimize(),
    onSolo: () => this.handleSoloToggle(),
    onMute: () => this.handleMuteToggle(),
    onNavigateBack: () => this.navigateBack(),
    onNavigateForward: () => this.navigateForward(),
    onNavigateReload: () => this.navigateReload()
  }
);

const titlebar = this.titlebarBuilder.build();
this.container.appendChild(titlebar);

// Store button references for updating
this.soloButton = this.titlebarBuilder.soloButton;
this.muteButton = this.titlebarBuilder.muteButton;
```

**Remove createTitlebar() method** from window.js.

**Update _updateTitleFromIframe()** to use `this.titlebarBuilder.updateTitle()`.

### Step 5: Add Comprehensive Tests

**Create:** `tests/unit/window/TitlebarBuilder.test.js`

**Test Coverage Requirements:**
- Constructor initialization
- build() creates all elements
- Navigation button callbacks
- Close/minimize button callbacks
- Solo/mute button callbacks
- updateTitle() updates text
- updateSoloButton() changes icon
- updateMuteButton() changes icon
- Favicon loading and error handling

**Minimum:** 20 tests to match existing component test coverage

### Step 6: Validate and Verify

1. **Run tests:**
   ```bash
   npm test -- tests/unit/window/TitlebarBuilder.test.js
   npm test  # All tests
   ```

2. **Check ESLint:**
   ```bash
   npx eslint src/features/quick-tabs/window.js
   # Should have only 1 warning now (render method too long)
   ```

3. **Build:**
   ```bash
   npm run build
   # Should succeed with no errors
   ```

4. **Verify line counts:**
   ```bash
   wc -l src/features/quick-tabs/window.js
   # Should be ~730 lines (was 879, -150 lines expected)
   
   wc -l src/features/quick-tabs/window/TitlebarBuilder.js
   # Should be ~200 lines
   ```

---

## Expected Impact

### Metrics Before Task 4

- window.js: 879 lines
- ESLint warnings in window.js: 2 (render + createTitlebar too long)
- Tests: 541/541 passing

### Metrics After Task 4 (Target)

- window.js: ~730 lines (-149 lines)
- ESLint warnings in window.js: 1 (only render too long)
- Tests: ~560/560 passing (+19 TitlebarBuilder tests)
- TitlebarBuilder: ~200 lines, cc<6
- Phase 2.9 progress: 75% complete

---

## Potential Gotchas

### 1. Button Reference Management

**Issue:** `window.js` stores references to `soloButton` and `muteButton` to update them.

**Solution:** TitlebarBuilder exposes these as public properties:
```javascript
this.soloButton = this.titlebarBuilder.soloButton;
this.muteButton = this.titlebarBuilder.muteButton;
```

### 2. Favicon Error Handling

**Issue:** Favicon loading uses try-catch and error callbacks.

**Solution:** Keep exact same error handling in `_createFavicon()`.

### 3. Navigation Button Availability

**Issue:** Navigation buttons might not exist in older Quick Tabs.

**Solution:** Make navigation buttons optional in TitlebarBuilder config.

### 4. Styling Consistency

**Issue:** Must maintain exact same styles as current implementation.

**Solution:** Copy all style objects verbatim during extraction.

---

## Files to Create/Modify

### New Files

- `src/features/quick-tabs/window/TitlebarBuilder.js` (~200 lines)
- `tests/unit/window/TitlebarBuilder.test.js` (~300 lines)

### Modified Files

- `src/features/quick-tabs/window.js` (remove createTitlebar(), integrate TitlebarBuilder)
- `docs/misc/v1.6.0-REFACTORING-MASTER-CHECKLIST.md` (mark Task 4 complete, update progress)

---

## Success Criteria

- [ ] TitlebarBuilder.js created with facade pattern
- [ ] All 157 lines of createTitlebar() logic extracted
- [ ] TitlebarBuilder integrated into window.js render()
- [ ] createTitlebar() method removed from window.js
- [ ] 20+ TitlebarBuilder tests added, all passing
- [ ] All 541 existing tests still passing
- [ ] Build successful with no errors
- [ ] window.js ESLint warnings reduced from 2 to 1
- [ ] window.js reduced by ~150 lines
- [ ] Master checklist updated
- [ ] Zero functional regressions

---

## Next Steps After Task 4

### Task 5 (Optional): Extract WindowStyler

**Complexity:** Medium  
**Lines Affected:** ~50 lines  
**Benefit:** Further reduces window.js complexity, improves theming support

### Task 6 (Optional): Add WindowFactory

**Complexity:** Low  
**Lines Affected:** ~30 lines  
**Benefit:** Centralizes QuickTabWindow creation with dependency injection

### Alternative: Start Phase 2.10

If Tasks 5-6 are skipped, move to Phase 2.10:
- Extract ManagerPanelUI (minimized tabs manager)
- Create ManagerPanelController
- Add ManagerPanelState

---

## Key Principles for Task 4

1. **Preserve exact functionality** - Zero behavior changes
2. **Follow facade pattern** - Match ResizeController/DragController approach
3. **Maintain test coverage** - Add 20+ tests for TitlebarBuilder
4. **Keep styling identical** - Copy all styles verbatim
5. **Handle edge cases** - Favicon errors, missing navigation buttons
6. **Update references properly** - Button refs must be accessible to window.js

---

## Reference Files

**Current Implementation:**
- `src/features/quick-tabs/window.js` (lines 219-376)

**Similar Patterns:**
- `src/features/quick-tabs/window/ResizeController.js` (facade pattern)
- `src/features/quick-tabs/window/DragController.js` (facade pattern)
- `tests/unit/window/ResizeHandle.test.js` (test structure)
- `tests/unit/window/DragController.test.js` (test structure)

**Documentation:**
- `docs/misc/v1.6.0-REFACTORING-MASTER-CHECKLIST.md` (progress tracking)
- `docs/misc/v1.6.0-REFACTORING-PHASE3.4-NEXT-STEPS.md` (previous handoff)

---

## Commands for Quick Start

```bash
# 1. View current createTitlebar implementation
view src/features/quick-tabs/window.js 219 376

# 2. Create TitlebarBuilder file
create src/features/quick-tabs/window/TitlebarBuilder.js

# 3. Create test file
create tests/unit/window/TitlebarBuilder.test.js

# 4. Run tests after implementation
npm test -- tests/unit/window/TitlebarBuilder.test.js

# 5. Verify all tests pass
npm test

# 6. Check ESLint improvements
npx eslint src/features/quick-tabs/window.js

# 7. Build to confirm no errors
npm run build

# 8. Update master checklist
edit docs/misc/v1.6.0-REFACTORING-MASTER-CHECKLIST.md
```

---

## Final Notes

This is a **straightforward extraction** following the established facade pattern. The main challenge is preserving exact functionality while organizing code better. Take time to understand the current implementation before extracting, and test thoroughly after integration.

**Estimated Time:** 2-3 hours

**Good luck!** ðŸš€
