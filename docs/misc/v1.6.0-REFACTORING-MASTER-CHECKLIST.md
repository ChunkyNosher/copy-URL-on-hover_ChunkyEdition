# v1.6.0 Refactoring Master Checklist

**Project:** copy-URL-on-hover_ChunkyEdition  
**Version:** 1.6.0  
**Architecture:** Domain-Driven Design with Clean Architecture  
**Status:** In Progress - Phase 7 Underway (83% Complete Overall)  
**Last Updated:** 2025-11-19 (Session 13 - Phase 7.3: QuickTabsManager Integration + TitlebarBuilder Tests - QuickTabsManager 45 tests (index.js 0% â†’ 88.37%), TitlebarBuilder +3 tests (94.85% â†’ 100%). Total tests: 1209 â†’ 1257 (+48). Feature layer coverage: 64.37% â†’ 68.82% (+4.45%). Code health: index.js 10.0, TitlebarBuilder 9.66, panel.js 10.0, window.js 8.73. ESLint: 0 errors, 2 warnings maintained)

---

## ðŸŽ¯ Overview

This checklist tracks the comprehensive refactoring of the extension from a hybrid modular/EventBus architecture to Domain-Driven Design with Clean Architecture. The refactoring follows evidence-based patterns from Mozilla, Chrome, and industry best practices.

**Quality Gates:**

- Domain Layer: 100% coverage required
- Storage Layer: 90% coverage required
- Features: 80% coverage required
- Complexity: cc â‰¤ 9, max-depth â‰¤ 2, max-lines â‰¤ 70

---

## Phase 0: Infrastructure & Testing Foundation

This phase establishes the build system, test infrastructure, and CI/CD workflows to support the modular architecture.

### Build System Enhancement

- [x] **Configure Rollup for multiple entry points** - Update rollup.config.js to bundle content.js, background.js, popup.js, and new modules with proper module aliasing.
- [x] **Add module path aliases** - Configure @domain, @storage, @features aliases for clean imports across the codebase.
- [x] **Enable tree-shaking** - Configure Rollup plugins to eliminate unused code from final bundle.
- [x] **Add bundle size monitoring** - Implement warnings when bundle size exceeds thresholds to prevent bloat.

### Test Infrastructure Enhancement

- [x] **Configure Jest for module paths** - Add moduleNameMapper to jest.config.cjs for @domain, @storage, @features aliases.
- [x] **Create layer-specific test patterns** - Update testMatch to recognize tests in new module hierarchy (src/features/\*/tests/).
- [x] **Add storage adapter mocks** - Create mocks for SyncStorageAdapter and SessionStorageAdapter in tests/**mocks**.
- [x] **Implement coverage thresholds** - Set per-layer coverage requirements: domain 100%, storage 90%, features 80%.

### CI/CD Workflow Updates

- [x] **Update code-quality.yml** - Add module-aware linting that validates import boundaries and circular dependencies.
- [x] **Update test-coverage.yml** - Add per-layer coverage reporting and enforce quality gates.
- [x] **Create architecture validation workflow** - Add ESLint rules to prevent cross-boundary violations (features â†’ domain ok, domain â†’ features forbidden).
- [x] **Update webext-lint.yml** - Ensure Firefox validation works with bundled output.

---

## Phase 1: Domain Layer & Storage Abstraction âœ… COMPLETE

This phase extracts pure business logic into framework-independent entities and creates an abstraction layer for browser storage APIs.

### Phase 1.1-1.2: Domain Entities âœ… COMPLETE (100% Coverage)

#### QuickTab Entity âœ…

- [x] **Extract QuickTab entity** - Create src/domain/QuickTab.js with 410 lines, 25 methods handling visibility, solo/mute operations, state updates, and serialization. Pure JavaScript with no browser API dependencies.

#### Container Entity âœ…

- [x] **Extract Container entity** - Create src/domain/Container.js with 207 lines, 13 methods for container type checking, validation, and factories. Handles Firefox Container isolation logic.

### Phase 1.3-1.4: Storage Abstraction Layer âœ… COMPLETE (92% Coverage)

#### Storage Adapters âœ…

- [x] **Create abstract StorageAdapter base class** - Define async-first interface with save(), load(), loadAll(), delete(), deleteContainer(), clear() methods.
- [x] **Implement SyncStorageAdapter** - Create adapter for browser.storage.sync with quota management (100KB limit), automatic fallback to local storage, and saveId tracking for race conditions.
- [x] **Implement SessionStorageAdapter** - Create adapter for browser.storage.session with no quota limits for temporary storage.

#### Format Migrator âœ…

- [x] **Create FormatMigrator with strategy pattern** - Implement migration support for v1.5.8.15+ (containers key), v1.5.8.14 (unwrapped containers), and legacy formats (flat tabs array).
- [x] **Add format detection** - Implement detect() method that identifies storage format version and returns appropriate strategy.

---

## Phase 2: QuickTabsManager Refactor

This phase decomposes the monolithic QuickTabsManager (1453 lines, cc=25) into a facade pattern with specialized components.

### Phase 2.1: Component Extraction âœ… COMPLETE (100%)

#### Managers (State & Communication) âœ…

- [x] **Extract StorageManager** - Create src/features/quick-tabs/managers/StorageManager.js (175 lines) handling persistent storage operations using StorageAdapter interface.
- [x] **Extract BroadcastManager** - Create src/features/quick-tabs/managers/BroadcastManager.js (180 lines) for cross-tab messaging via BroadcastChannel API.
- [x] **Extract StateManager** - Create src/features/quick-tabs/managers/StateManager.js (194 lines) for local in-memory state management with event emission.
- [x] **Extract EventManager** - Create src/features/quick-tabs/managers/EventManager.js (116 lines) for DOM event handling and keyboard shortcuts.

#### Handlers (Business Logic) âœ…

- [x] **Extract CreateHandler** - Create src/features/quick-tabs/handlers/CreateHandler.js (167 lines) encapsulating Quick Tab creation logic with validation and persistence.
- [x] **Extract UpdateHandler** - Create src/features/quick-tabs/handlers/UpdateHandler.js (141 lines) handling position and size updates with debouncing.
- [x] **Extract VisibilityHandler** - Create src/features/quick-tabs/handlers/VisibilityHandler.js (238 lines) managing solo/mute/minimize operations.
- [x] **Extract DestroyHandler** - Create src/features/quick-tabs/handlers/DestroyHandler.js (155 lines) coordinating cleanup logic for closing Quick Tabs.

#### Coordinators (Orchestration) âœ…

- [x] **Extract UICoordinator** - Create src/features/quick-tabs/coordinators/UICoordinator.js (182 lines) rendering QuickTabWindow instances from QuickTab entities and managing lifecycle.
- [x] **Extract SyncCoordinator** - Create src/features/quick-tabs/coordinators/SyncCoordinator.js (145 lines) routing broadcast messages and coordinating storage â†” state sync.

### Phase 2.2: Facade Integration âœ… COMPLETE

#### Facade Implementation âœ…

- [x] **Create QuickTabsManager facade** - Refactor src/features/quick-tabs/QuickTabsManager/index.js from 1453 lines to 529 lines by delegating to extracted components.
- [x] **Wire component dependencies** - Inject dependencies (StateManager, StorageManager, etc.) into facade constructor for loose coupling.
- [x] **Maintain public API** - Ensure all existing public methods delegate to appropriate components without breaking consumers.
- [x] **Reduce complexity metrics** - Achieve mean cc <3, max cc <9, all methods <70 lines (from cc mean 6.74, max 25).

### Phase 2.3-2.8: ESLint Cleanup & Pattern Demonstration âœ… COMPLETE (100%)

#### Import Ordering & Basic Fixes âœ… COMPLETE

- [x] **Fix content.js import ordering** - Resolve 12 ESLint errors related to import statement organization (Phase 2.3)
- [x] **Add missing semicolons** - Fix punctuation-related ESLint warnings across codebase (Phase 2.3)

#### Complexity Reduction Demonstrations âœ… COMPLETE

- [x] **Create ResizeHandle component** - Build src/features/quick-tabs/window/ResizeHandle.js (281 lines) with table-driven configuration for 8 resize directions, reducing complexity from cc=25 to cc=3 (Phase 2.3)
- [x] **Create ResizeController facade** - Build src/features/quick-tabs/window/ResizeController.js (60 lines) to replace 195-line setupResizeHandlers method (Phase 2.3)
- [x] **Add comprehensive tests** - Write 22 tests for ResizeHandle/ResizeController components with 100% coverage (Phase 2.3)

#### ESLint Warning Reduction âœ… COMPLETE

- [x] **Phase 2.4-2.5:** Initial warning reduction (88 â†’ 82 warnings, -7%) - Window.js and basic cleanup
- [x] **Phase 2.6:** Major warning reduction (82 â†’ 36 warnings, -56%) - Systematic unused variable cleanup, no-return-await fixes, 40 warnings eliminated
- [x] **Phase 2.7:** Continued warning reduction (36 â†’ 32 warnings, -11%) - Genuine require-await fixes, remaining unused variables
- [x] **Phase 2.8:** Final warning reduction (32 â†’ 11 warnings, -66%) - Test file/abstract class suppressions, legitimate async method handling. **STRETCH GOAL EXCEEDED** (target was <30, achieved 11 = 88% reduction from baseline)

#### ESLint Error Reduction âœ… MAJOR PROGRESS (83% reduction achieved from baseline)

- [x] **Phase 2.6:** Minor error reduction (83 â†’ 79 errors, -5%) - Fixed debug import in social-media.js
- [x] **Phase 2.11:** Removed old unused files (79 â†’ 33 errors, -58%) - Deleted index-old.js, panel-old.js, DragController.test.old.js
- [x] **Phase 2.12:** Refactored QuickTabHandler (33 â†’ 32 errors, -1%) - Extracted updateQuickTabProperty helper, eliminated 6 duplicate patterns, code health 8.54â†’9.38
- [x] **Phase 2.13:** Fixed handler bugs and warnings (32 â†’ 31 errors, -1%, 9 â†’ 3 warnings, -67%) - Fixed critical LogHandler bug (undefined downloadId), removed unnecessary async keywords
- [x] **Phase 2.14:** Fixed max-depth violations (31 â†’ 28 errors, -10%) - Applied early returns in QuickTabHandler, options_page.js, test mocks, validation script
- [x] **Phase 2.15:** Refactored state-manager.js (28 â†’ 23 errors, -18%) - Extracted \_loadFromSession and \_loadFromSync helpers, reduced complexity 11â†’3, code health 7.91â†’8.28
- [x] **Phase 4.2 Task 1:** Refactored popup.js (23 â†’ 15 errors, -35%) - Extracted 10 helpers, reduced complexity exportAllLogs 13â†’<9, getContentScriptLogs 10â†’<9, code health 8.24â†’9.28
- [x] **Phase 4.2 Task 2:** Refactored sidebar/panel.js (15 â†’ 12 errors, -20%) - Extracted 4 storage/rendering helpers, reduced complexity 12â†’<9, code health 9.24â†’9.68
- [x] **Phase 4.2 Task 3:** Refactored sidebar/quick-tabs-manager.js (12 â†’ 11 errors, -8%) - Extracted 3 DOM creation helpers, reduced renderQuickTabItem 83 linesâ†’23 lines, complexity 13â†’<9, code health 8.46â†’9.38
- [x] **Phase 4.2 Task 4:** Fixed test mock (11 â†’ 10 errors, -9%) - Replaced for-loop with reduce() in browser-storage.js mock
- [x] **Phase 4.3:** Fixed all 10 background.js errors (10â†’0 errors, -100%) - Extracted 11 helper functions, reduced complexity, eliminated all max-depth violations

### Phase 2.9: Window Component Integration â³ IN PROGRESS (80%)

#### QuickTabWindow Refactor

- [x] **Integrate ResizeController** - ResizeController already integrated in window.js (COMPLETE from previous session) - facade pattern reduces complexity, eliminates 195 lines of resize logic.
- [x] **Extract DragController** - Created src/features/quick-tabs/window/DragController.js (181 lines, cc<6) with Pointer Events API to support Issue #51 fix. 19 comprehensive tests added (541/541 passing).
- [x] **Integrate DragController into window.js** - Replaced setupDragHandlers (~50 lines) with DragController facade using Pointer Events API (pointerdown/move/up/cancel). Added onDragCancel callback for emergency position save on tab switch.
- [x] **Create TitlebarBuilder component** - Created src/features/quick-tabs/window/TitlebarBuilder.js (~450 lines, cc<6) extracting createTitlebar (157 lines), createFavicon (26 lines), createButton (38 lines), applyZoom (18 lines). Added 44 comprehensive tests. window.js reduced from 918 â†’ 647 lines (-271 lines, -30%). ESLint warnings reduced from 2 â†’ 1 (only render method remains).
- [ ] **Create WindowStyler component (OPTIONAL)** - Extract styling logic (dark mode, themes, animations) into dedicated component. Low priority - current architecture sufficient.
- [ ] **Add WindowFactory (OPTIONAL)** - Implement factory pattern for creating QuickTabWindow instances with proper dependency injection. Low priority - direct instantiation works well.

### Phase 2.10: Quick Tabs Manager Panel Refactor âœ… COMPLETE (100%)

#### Panel Component Extraction

- [x] **Extract PanelUIBuilder** - Created src/features/quick-tabs/panel/PanelUIBuilder.js (~450 lines, cc<3) for DOM creation and rendering. Added 32 comprehensive tests (all passing). Zero ESLint errors. âœ… SESSION 1
- [x] **Extract PanelDragController** - Created src/features/quick-tabs/panel/PanelDragController.js (~150 lines, cc<4) for drag handling with Pointer Events API. Added 24 comprehensive tests (all passing). Zero ESLint errors. âœ… SESSION 1
- [x] **Extract PanelResizeController** - Created src/features/quick-tabs/panel/PanelResizeController.js (~300 lines, ccâ‰¤3) for 8-direction resize handling using table-driven configuration. Added 25 comprehensive tests (all passing). Zero ESLint errors. âœ… SESSION 2
- [x] **Extract PanelStateManager** - Created src/features/quick-tabs/panel/PanelStateManager.js (~245 lines, ccâ‰¤3) for state persistence, BroadcastChannel sync, and container detection. Added 27 comprehensive tests (all passing). Zero ESLint errors. âœ… SESSION 2
- [x] **Extract PanelContentManager** - Created src/features/quick-tabs/panel/PanelContentManager.js (~480 lines, ccâ‰¤6) for content updates and Quick Tab operations. Added 33 comprehensive tests (all passing). Zero ESLint errors. âœ… SESSION 3
- [x] **Refactor PanelManager to facade** - Refactored src/features/quick-tabs/panel.js from 1497 lines to 408 line facade orchestrating all 5 components. Zero ESLint errors. âœ… SESSION 3

**Final Impact Achieved:**

- panel.js: 1497 â†’ 408 lines (-1089 lines, -73%) âœ… EXCEEDED TARGET
- Tests: 583 â†’ 724 (+141 tests, all passing) âœ… EXCEEDED TARGET
- ESLint: panel.js 0 errors âœ… TARGET MET
- All complexity targets met (cc â‰¤ 6, max-depth â‰¤ 2, max-lines â‰¤ 70) âœ… TARGET MET
- All 5 panel components: 0 errors, 0 warnings âœ… PERFECT QUALITY

---

## Phase 3: Background Script Refactor â³ IN PROGRESS

This phase transforms background.js from a monolithic event handler (628 lines, cc=93) into a coordinator using message routing pattern.

### Phase 3.1: Message Handler Extraction âœ… COMPLETE (100%)

#### Message Routing Infrastructure âœ… COMPLETE

- [x] **Create MessageRouter** - Built src/background/MessageRouter.js (121 lines) with handler registry pattern for routing messages based on action type
- [x] **Create LogHandler** - Built src/background/handlers/LogHandler.js (142 lines) for CLEAR_CONSOLE_LOGS, GET_BACKGROUND_LOGS, EXPORT_LOGS actions
- [x] **Create QuickTabHandler** - Built src/background/handlers/QuickTabHandler.js (372 lines) for 13 Quick Tab CRUD operations (CREATE, CLOSE, UPDATE_POSITION, UPDATE_SIZE, etc.)
- [x] **Create TabHandler** - Built src/background/handlers/TabHandler.js (91 lines) for browser tab management (openTab, saveState, getState, clearState)

#### Handler Integration âœ… COMPLETE

- [x] **Integrate MessageRouter into background.js** - Replaced 628-line monolithic message handler with MessageRouter.createListener() (1 line)
- [x] **Register all handlers** - Wired up 21 action handlers (3 log + 13 Quick Tab + 5 tab actions)
- [x] **Update build configuration** - Added background.js to Rollup bundling for ES6 module support
- [x] **Test handler integration** - Verified all message actions route correctly, 522/522 tests passing
- [x] **Remove unused functions** - Removed isAuthorizedExtensionSender, clearBackgroundLogs, handleLogExport (now in handlers)

**Actual Impact Achieved:**

- background.js: 1795 â†’ 954 lines (-841 lines, -47%) âœ… EXCEEDED TARGET
- Message handler: 628 â†’ 1 line (-627 lines, -99.8%) âœ… EXCEEDED TARGET
- Complexity: cc=93 â†’ cc<3 per handler âœ… ACHIEVED
- ESLint errors in background.js: 36 â†’ 20 (-16 errors, -44%) âœ… CLOSE TO TARGET
- Total ESLint errors: 82 â†’ 68 (-14 errors, -17%)
- Tests: 522/522 passing âœ… MAINTAINED

### Phase 3.2: Remaining Complexity Reduction âœ… COMPLETE (100%)

#### State Initialization âœ… COMPLETE

- [x] **Extract format migration logic** - Created StorageFormatDetector and 3 migrator strategy classes (V1_5_8_15, V1_5_8_14, Legacy)
- [x] **Simplify initializeGlobalState** - Reduced cc=20 â†’ cc<5 by extracting 4 helper methods (tryLoadFromSessionStorage, tryLoadFromSyncStorage, saveMigratedLegacyFormat, logSuccessfulLoad)
- [x] **Simplify migrateQuickTabState** - Reduced cc=10 â†’ cc<6 by extracting 2 helpers (migrateTabFromPinToSoloMute, saveMigratedQuickTabState)
- [x] **Flatten nested blocks** - Addressed 15 max-depth violations in background.js (-75% in refactored code) using early returns and guard clauses

#### State Coordinator âœ… COMPLETE

- [x] **Flatten StateCoordinator.initialize** - Reduced cc=15 â†’ cc<6 by extracting 3 helpers (tryLoadFromSessionStorage, tryLoadFromSyncStorage, loadStateFromSyncData)
- [x] **Flatten StateCoordinator.processOperation** - Reduced cc=12 â†’ cc<6 by extracting 5 operation handlers (create, update, delete, minimize, restore)
- [ ] **Add unit tests for StateCoordinator** - Test batch updates, vector clocks, persistence (deferred to Phase 7)
- [ ] **Extract broadcast logic** - Separate cross-tab messaging into dedicated module (deferred to Phase 4)
- [ ] **Document state flow** - Create sequence diagrams for state synchronization (deferred to Phase 7)

**Actual Impact Achieved:**

- background.js ESLint errors: 20 â†’ 10 (-50%) âœ… EXCEEDED TARGET (<13)
- Total ESLint errors: 68 â†’ 57 (-16%) âœ… PROGRESS
- All refactored functions: cc<9 âœ… ACHIEVED
- Nested blocks in refactored code: max-depthâ‰¤2 âœ… ACHIEVED
- Tests: 522/522 passing âœ… MAINTAINED
- background.js: 952 â†’ 1126 lines (+174 lines for helper methods, but complexity dramatically reduced)

---

## Phase 4: Content Script Refactor

This phase modularizes content.js by separating URL detection, UI rendering, and event handling concerns.

### Phase 4.1: URL Detection System

#### Site Handler Refactor

- [ ] **Extract SiteHandlerRegistry** - Create src/content/url-detection/SiteHandlerRegistry.js managing 100+ site-specific handlers with lazy loading.
- [ ] **Create AbstractSiteHandler base class** - Define interface for site handlers (detect(), extractUrl(), getPriority()) to standardize handler implementations.
- [ ] **Refactor generic handler** - Extract src/content/url-detection/handlers/GenericHandler.js as fallback for sites without specific handlers.
- [ ] **Implement handler composition** - Allow combining multiple handlers (e.g., Twitter handler + generic link detection) using composite pattern.

#### Detection Pipeline

- [ ] **Create HoverDetectionPipeline** - Build src/content/url-detection/HoverDetectionPipeline.js to coordinate mouseover events â†’ handler selection â†’ URL extraction flow.
- [ ] **Add caching layer** - Implement memoization for repeated hover detection on same element to improve performance.

### Phase 4.2: UI Rendering System

#### Notification Refactor

- [ ] **Extract NotificationRenderer** - Create src/content/ui/NotificationRenderer.js handling tooltip/notification display with animations.
- [ ] **Create NotificationStyler** - Build src/content/ui/NotificationStyler.js for applying user-configured styles (position, size, color, border).
- [ ] **Extract AnimationController** - Create src/content/ui/AnimationController.js for slide/pop/fade animations with configurable timing.

#### Manager Integration

- [ ] **Create UIManager facade** - Build src/content/ui/UIManager.js as single entry point for all content script UI operations.
- [ ] **Wire rendering pipeline** - Connect hover detection â†’ URL extraction â†’ notification rendering â†’ Quick Tab creation flow through UIManager.

### Phase 4.3: Event Handling System

#### Event Coordinators

- [ ] **Extract KeyboardEventHandler** - Create src/content/events/KeyboardEventHandler.js for copy/text/open-tab shortcuts with modifier key detection.
- [ ] **Extract MouseEventHandler** - Create src/content/events/MouseEventHandler.js for mouseover/mouseout with debouncing.
- [ ] **Create EventCoordinator** - Build src/content/events/EventCoordinator.js to manage all event listeners and prevent memory leaks.

---

## Phase 5: Popup/Options UI Refactor

This phase modularizes the settings UI by separating form handling, validation, and storage synchronization.

### Phase 5.1: Settings Management

#### Settings Components

- [ ] **Extract SettingsManager** - Create src/popup/SettingsManager.js as facade for loading/saving/resetting settings via browser.storage.
- [ ] **Create SettingsValidator** - Build src/popup/SettingsValidator.js for validating hex colors, numeric ranges, and enum values.
- [ ] **Extract FormController** - Create src/popup/FormController.js to coordinate form elements â†” settings data binding.

### Phase 5.2: UI Components

#### Tab System

- [ ] **Create TabNavigator** - Extract src/popup/TabNavigator.js for switching between Copy URL/Quick Tabs/Appearance/Advanced tabs.
- [ ] **Extract ColorPicker component** - Build src/popup/components/ColorPicker.js for hex input with live preview.
- [ ] **Create DropdownController** - Extract src/popup/components/DropdownController.js for select elements with custom styling.

### Phase 5.3: Options Page

#### Options Refactor

- [ ] **Mirror popup architecture** - Apply same component extraction pattern to options_page.js for consistency.
- [ ] **Create OptionsCoordinator** - Build facade similar to SettingsManager for options page specific logic.

---

## Phase 6: Shared Utilities & Helpers âœ… COMPLETE

This phase extracts common utility functions into reusable modules to reduce duplication.

### Phase 6.1: Core Utilities âœ… COMPLETE

#### Utility Modules

- [ ] **Create DOMUtils** - Extract src/shared/utils/DOMUtils.js for createElement, classList, event delegation helpers. (DEFERRED - Low priority)
- [x] **Create ValidationUtils** - Built src/utils/validation.js with 18 validation functions (URL, container ID, dimensions, positions, tab IDs, colors, types). 100% test coverage (76 tests). Code health 8.67/10. âœ… COMPLETE
- [ ] **Create StringUtils** - Create src/shared/utils/StringUtils.js for text truncation, sanitization, formatting. (DEFERRED - Low priority)
- [ ] **Create MathUtils** - Build src/shared/utils/MathUtils.js for viewport clamping, position calculation, bounds checking. (DEFERRED - Low priority)

#### Manager Test Coverage Improvements âœ… COMPLETE

- [x] **Improve StorageManager coverage** - Increased from 68.93% to 100% (+31.07%). Added 28 tests covering error paths, edge cases, race conditions. âœ… COMPLETE
- [x] **Improve BroadcastManager coverage** - Increased from 92.64% to 100% (+7.36%). Added 8 tests covering error handling, message reception, debouncing. âœ… COMPLETE
- [x] **Improve StateManager coverage** - Increased from 94.52% to 100% (+5.48%). Added 6 tests covering error handling, validation, edge cases. âœ… COMPLETE

### Phase 6.2: Browser API Wrappers

#### API Facades (DEFERRED - Not needed)

- [ ] **Create StorageFacade** - Build src/shared/facades/StorageFacade.js wrapping browser.storage with consistent error handling. (DEFERRED - Storage adapters already provide this)
- [ ] **Create MessageFacade** - Create src/shared/facades/MessageFacade.js wrapping browser.runtime.sendMessage with type safety. (DEFERRED - MessageRouter already handles this)
- [ ] **Create TabsFacade** - Build src/shared/facades/TabsFacade.js wrapping browser.tabs with promise-based API. (DEFERRED - Not needed yet)

---

## Phase 7: Testing & Documentation â³ IN PROGRESS (30%)

This phase ensures comprehensive test coverage and clear documentation for the refactored architecture.

### Phase 7.1-7.3: Feature Layer Test Coverage â³ IN PROGRESS (69%)

#### Component Tests (Sessions 11-13 Progress)

- [x] **window.js tests** - 86.38% coverage (89 tests). Covers constructor, render(), drag/resize, minimize/restore, position/size, solo/mute, isRendered(), destroy(), getState(). âœ… COMPLETE (Session 10)
- [x] **minimized-manager.js tests** - 100% coverage (40 tests). Covers add(), remove(), restore(), getAll(), getCount(), isMinimized(), clear(), integration scenarios, edge cases. âœ… COMPLETE (Session 10)
- [x] **ResizeController.js tests** - 100% coverage (31 tests). Tests constructor, attachHandles(), detachAll(), getHandle(), edge cases, integration with ResizeHandle, memory management. âœ… COMPLETE (Session 11) **EXCEEDED TARGET (80%)**
- [x] **ResizeHandle.js tests** - 100% coverage (36 tests, +14 from session 11). Tests pointer event handlers (pointerdown, pointermove, pointerup, pointercancel), resize state management, dimension updates, callback invocations, emergency save. âœ… COMPLETE (Session 12) **PERFECT SCORE**
- [x] **notifications system tests** - 100% coverage (133 tests total). NotificationManager (40 tests), Toast (46 tests), Tooltip (47 tests). Tests routing, creation, positioning, animations, styling, auto-dismiss, edge cases. âœ… COMPLETE (Session 11) **EXCEEDED TARGET (70%)**
- [x] **panel.js integration tests** - 69.53% coverage (58 tests). Tests panel lifecycle (init/open/close/toggle), component delegation (5 components), container detection, state coordination, auto-refresh, error handling. âœ… COMPLETE (Session 12) **EXCEEDED TARGET (60%)**
- [x] **index.js (QuickTabsManager) integration tests** - 88.37% coverage (45 tests). Tests facade initialization, component delegation for all CRUD operations, state management, utility methods, error handling, legacy API compatibility. âœ… COMPLETE (Session 13) **EXCEEDED TARGET (60%)**
- [x] **TitlebarBuilder.js tests** - 100% coverage (47 tests, +3 from session 12). Tests all titlebar functionality, navigation buttons, zoom controls, favicon handling, solo/mute buttons, cross-origin error handling, zoom fallback with CSS transform. âœ… COMPLETE (Session 13) **PERFECT SCORE**

#### Unit Tests (Phase 7.1-7.3 Progress)

- [x] **Achieve 100% domain layer coverage** - QuickTab and Container entities at 100% coverage. âœ… ACHIEVED
- [x] **Achieve 90% storage layer coverage** - Storage adapters at 92.30% coverage. âœ… ACHIEVED
- [ ] **Achieve 80% feature coverage** - Currently at 68.82% (was 64.37%, +4.45%), target 80%. In Progress. Need: +11.18% coverage

#### Integration Tests

- [x] **Create QuickTabsManager facade integration tests** - 45 tests covering component orchestration, delegation, state management. âœ… COMPLETE (Session 13)
- [ ] **Create cross-component integration tests** - Test complete flows (create Quick Tab â†’ persist â†’ sync â†’ render) across component boundaries.
- [ ] **Add browser API integration tests** - Test storage adapters against mock browser.storage with realistic scenarios.

### Phase 7.2: Documentation

#### Architecture Documentation

- [ ] **Create architecture decision records (ADRs)** - Document key refactoring decisions (facade pattern, strategy pattern) in docs/architecture/.
- [ ] **Update README with new architecture** - Explain Domain-Driven Design structure, component responsibilities, and data flow.
- [ ] **Create developer guide** - Write docs/DEVELOPER-GUIDE.md explaining how to add new features in the refactored architecture.

#### Code Documentation

- [ ] **Add JSDoc comments to public APIs** - Document all public methods with @param, @returns, @throws tags.
- [ ] **Create module README files** - Add README.md in each major directory (src/domain/, src/features/, src/background/) explaining module purpose.

---

## Completion Criteria

### Quality Metrics (Updated 2025-11-19 Session 13 - Phase 7.3: QuickTabsManager Integration + TitlebarBuilder Complete)

- âœ… Domain Layer: 100% coverage (currently 100%) âœ… ACHIEVED
- âœ… Storage Layer: 90% coverage (currently 92.30%) âœ… ACHIEVED
- â³ Feature Layer: 80% coverage (currently 68.82%, was 64.37%, +4.45%) - **+48 tests this session (1257 total, was 1209)**
- âœ… Managers: 100% coverage (StorageManager, BroadcastManager, StateManager all at 100%) âœ… ACHIEVED
- âœ… ValidationUtils: 100% coverage (18 functions, 76 tests) âœ… ACHIEVED
- âœ… window.js: 86.38% coverage (89 tests) âœ… EXCEEDS TARGET (70%+)
- âœ… minimized-manager.js: 100% coverage (40 tests) âœ… PERFECT SCORE
- âœ… ResizeController.js: 100% coverage (31 tests) âœ… PERFECT SCORE
- âœ… ResizeHandle.js: 100% coverage (36 tests) âœ… PERFECT SCORE
- âœ… NotificationManager: 100% coverage (40 tests) âœ… PERFECT SCORE
- âœ… Toast.js: 100% coverage (46 tests) âœ… PERFECT SCORE
- âœ… Tooltip.js: 100% coverage (47 tests) âœ… PERFECT SCORE
- âœ… panel.js: 69.53% coverage (58 tests) âœ… EXCEEDS TARGET (60%+)
- âœ… index.js (QuickTabsManager): 88.37% coverage (45 tests) âœ… EXCEEDS TARGET (60%+) - **NEW SESSION 13**
- âœ… TitlebarBuilder.js: 100% coverage (47 tests, +3 from session 12) âœ… PERFECT SCORE - **NEW SESSION 13**
- âœ… ESLint: 0 errors (maintained from sessions 8-13) âœ… ACHIEVED
- âœ… ESLint: <30 warnings (currently 2, maintained from sessions 8-13) âœ… ACHIEVED
- âœ… Complexity in refactored code: All cc â‰¤ 9 âœ… ACHIEVED (all refactored functions cc<9)
- âœ… Message handler: â‰¤ 70 lines (reduced from 628 lines to 1 line) âœ… ACHIEVED
- âœ… window.js: Max-lines-per-function warnings reduced from 2 â†’ 1 âœ… ACHIEVED (only render remains)
- âœ… Tests: 1257/1259 passing (1255 + 2 skipped, all green) âœ… MAINTAINED (+48 tests from session 12)
- âœ… Code Health: All refactored components 8.7-10.0 range âœ… EXCELLENT (index.js: 10.0, TitlebarBuilder: 9.66, panel.js: 10.0, window.js: 8.73)

### Functional Requirements

- âœ… 100% backward compatibility maintained
- âœ… All user-facing features work identically
- âœ… Settings and storage format remain compatible
- âœ… Firefox and Zen Browser compatibility preserved
- â³ Performance equals or exceeds current implementation (need to measure)

### Documentation Requirements

- â³ All public APIs documented with JSDoc
- â³ Architecture diagrams created
- â³ Developer guide complete
- â³ Migration guide for contributors

---

## Progress Summary

**Overall Progress: ~83%** (updated 2025-11-19 session 13 - Phase 7.3: QuickTabsManager Integration + TitlebarBuilder Complete)

| Phase                              | Status         | Progress | Details                                                                                                                                     |
| ---------------------------------- | -------------- | -------- | ------------------------------------------------------------------------------------------------------------------------------------------- |
| Phase 0: Infrastructure            | âœ… Complete    | 100%     | Build, test, CI/CD setup                                                                                                                    |
| Phase 1: Domain + Storage          | âœ… Complete    | 100%     | QuickTab, Container, adapters                                                                                                               |
| Phase 2.1: Component Extraction    | âœ… Complete    | 100%     | Managers, handlers, coordinators                                                                                                            |
| Phase 2.2: Facade Integration      | âœ… Complete    | 100%     | QuickTabsManager facade                                                                                                                     |
| Phase 2.3-2.8: ESLint Cleanup      | âœ… Complete    | 100%     | 88 â†’ 11 warnings (-88%), handlers created                                                                                                   |
| Phase 2.9: Window Components       | âœ… Complete    | 100%     | ResizeController âœ…, DragController âœ…, TitlebarBuilder âœ…                                                                                  |
| Phase 2.10: Manager Panel Refactor | âœ… Complete    | 100%     | All 5 components + facade âœ… (1497â†’408 lines, +141 tests, 0 ESLint errors)                                                                  |
| Phase 2.11-2.15: ESLint Reduction  | âœ… Complete    | 100%     | 60â†’23 errors (-62%), 25â†’3 warnings (-88%), handlers + state-manager refactored                                                              |
| Phase 3.1: Background Refactor     | âœ… Complete    | 100%     | MessageRouter integrated, -841 lines                                                                                                        |
| Phase 3.2: Complexity Reduction    | âœ… Complete    | 100%     | Format strategies extracted, -50% errors in bg.js                                                                                           |
| Phase 4.2: Final ESLint Cleanup    | âœ… Complete    | 100%     | popup.js (8â†’0 errors), sidebar files (4â†’0 errors), 23â†’10 total errors (-56.5%)                                                              |
| Phase 4.3: Background.js Cleanup   | âœ… Complete    | 100%     | background.js (10â†’0 errors), ALL ESLint errors eliminated, code health 9.24/10                                                              |
| Phase 4: Content Script Refactor   | ðŸ“ Not Started | 0%       | URL detection, UI rendering (content.js already has 9.68 code health - may not need it)                                                     |
| Phase 5: Popup/Options Refactor    | ðŸ“ Partial     | 50%      | popup.js refactored âœ…, options_page.js pending                                                                                             |
| Phase 6: Utilities                 | âœ… Complete    | 100%     | ValidationUtils extracted (18 functions, 100% coverage). Manager coverage: 3 managers at 100% (+118 tests session 9) âœ…                     |
| Phase 7: Testing & Docs            | â³ In Progress | 30%      | QuickTabsManager 88% âœ…, TitlebarBuilder 100% âœ…, Panel 69% âœ…, ResizeHandle 100% âœ…, Notifications 100% âœ…. Feature: 68.82%. +286 tests âœ… |

**Next Priority:** Phase 7 (Test coverage improvements) - Continue testing remaining components. Options: Playwright E2E tests (5-7 scenarios), StateCoordinator tests, or additional component coverage. Target: 80%+ feature layer coverage (currently 68.82%, need +11.18%).

---

## How Copilot Agents Should Use This Checklist

### For refactor-specialist Agent

1. **At start of session**: Read this checklist to understand current progress
2. **Select work items**: Choose items from current phase (Phase 2.3 now) or next phase if current is blocked
3. **Update checklist**: After completing work, mark items as [x] and update Progress Summary
4. **Report status**: Use checklist items as basis for commit messages and PR descriptions

### For other agents

- **bug-fixer**: Check if bugs are related to refactored components before fixing
- **feature-builder**: Coordinate with refactor-specialist to avoid conflicts
- **master-orchestrator**: Use checklist to delegate work between agents

### Checklist Update Process

1. Mark completed items with [x]
2. Update "Last Updated" date at top
3. Recalculate "Overall Progress" percentage
4. Update "Progress Summary" table
5. Update "Next Priority" statement
6. Commit changes with descriptive message

---

## Notes

- **Token Efficiency**: This checklist reduces documentation verbosity by consolidating all phase information into one file
- **Evidence-Based**: All items derived from Mozilla/Chrome best practices and CodeScene analysis
- **Flexible**: Items can be completed out of order if dependencies allow
- **Living Document**: Expected to evolve as refactoring reveals new requirements
- **Agent-Friendly**: Structured for easy parsing by Copilot Coding Agent
