# v1.6.0 Refactoring Master Checklist

**Project:** copy-URL-on-hover_ChunkyEdition  
**Version:** 1.6.0  
**Architecture:** Domain-Driven Design with Clean Architecture  
**Status:** In Progress - Phase 2.7 (43% Complete Overall)  
**Last Updated:** 2025-01-18 (Session: Phase 2.7 continuation)

---

## ðŸŽ¯ Overview

This checklist tracks the comprehensive refactoring of the extension from a hybrid modular/EventBus architecture to Domain-Driven Design with Clean Architecture. The refactoring follows evidence-based patterns from Mozilla, Chrome, and industry best practices.

**Quality Gates:**

- Domain Layer: 100% coverage required
- Storage Layer: 90% coverage required
- Features: 80% coverage required
- Complexity: cc â‰¤ 9, max-depth â‰¤ 2, max-lines â‰¤ 70

---

## Phase 0: Infrastructure & Testing Foundation

This phase establishes the build system, test infrastructure, and CI/CD workflows to support the modular architecture.

### Build System Enhancement

- [x] **Configure Rollup for multiple entry points** - Update rollup.config.js to bundle content.js, background.js, popup.js, and new modules with proper module aliasing.
- [x] **Add module path aliases** - Configure @domain, @storage, @features aliases for clean imports across the codebase.
- [x] **Enable tree-shaking** - Configure Rollup plugins to eliminate unused code from final bundle.
- [x] **Add bundle size monitoring** - Implement warnings when bundle size exceeds thresholds to prevent bloat.

### Test Infrastructure Enhancement

- [x] **Configure Jest for module paths** - Add moduleNameMapper to jest.config.cjs for @domain, @storage, @features aliases.
- [x] **Create layer-specific test patterns** - Update testMatch to recognize tests in new module hierarchy (src/features/\*/tests/).
- [x] **Add storage adapter mocks** - Create mocks for SyncStorageAdapter and SessionStorageAdapter in tests/**mocks**.
- [x] **Implement coverage thresholds** - Set per-layer coverage requirements: domain 100%, storage 90%, features 80%.

### CI/CD Workflow Updates

- [x] **Update code-quality.yml** - Add module-aware linting that validates import boundaries and circular dependencies.
- [x] **Update test-coverage.yml** - Add per-layer coverage reporting and enforce quality gates.
- [x] **Create architecture validation workflow** - Add ESLint rules to prevent cross-boundary violations (features â†’ domain ok, domain â†’ features forbidden).
- [x] **Update webext-lint.yml** - Ensure Firefox validation works with bundled output.

---

## Phase 1: Domain Layer & Storage Abstraction âœ… COMPLETE

This phase extracts pure business logic into framework-independent entities and creates an abstraction layer for browser storage APIs.

### Phase 1.1-1.2: Domain Entities âœ… COMPLETE (100% Coverage)

#### QuickTab Entity âœ…

- [x] **Extract QuickTab entity** - Create src/domain/QuickTab.js with 410 lines, 25 methods handling visibility, solo/mute operations, state updates, and serialization. Pure JavaScript with no browser API dependencies.

#### Container Entity âœ…

- [x] **Extract Container entity** - Create src/domain/Container.js with 207 lines, 13 methods for container type checking, validation, and factories. Handles Firefox Container isolation logic.

### Phase 1.3-1.4: Storage Abstraction Layer âœ… COMPLETE (92% Coverage)

#### Storage Adapters âœ…

- [x] **Create abstract StorageAdapter base class** - Define async-first interface with save(), load(), loadAll(), delete(), deleteContainer(), clear() methods.
- [x] **Implement SyncStorageAdapter** - Create adapter for browser.storage.sync with quota management (100KB limit), automatic fallback to local storage, and saveId tracking for race conditions.
- [x] **Implement SessionStorageAdapter** - Create adapter for browser.storage.session with no quota limits for temporary storage.

#### Format Migrator âœ…

- [x] **Create FormatMigrator with strategy pattern** - Implement migration support for v1.5.8.15+ (containers key), v1.5.8.14 (unwrapped containers), and legacy formats (flat tabs array).
- [x] **Add format detection** - Implement detect() method that identifies storage format version and returns appropriate strategy.

---

## Phase 2: QuickTabsManager Refactor

This phase decomposes the monolithic QuickTabsManager (1453 lines, cc=25) into a facade pattern with specialized components.

### Phase 2.1: Component Extraction âœ… COMPLETE (100%)

#### Managers (State & Communication) âœ…

- [x] **Extract StorageManager** - Create src/features/quick-tabs/managers/StorageManager.js (175 lines) handling persistent storage operations using StorageAdapter interface.
- [x] **Extract BroadcastManager** - Create src/features/quick-tabs/managers/BroadcastManager.js (180 lines) for cross-tab messaging via BroadcastChannel API.
- [x] **Extract StateManager** - Create src/features/quick-tabs/managers/StateManager.js (194 lines) for local in-memory state management with event emission.
- [x] **Extract EventManager** - Create src/features/quick-tabs/managers/EventManager.js (116 lines) for DOM event handling and keyboard shortcuts.

#### Handlers (Business Logic) âœ…

- [x] **Extract CreateHandler** - Create src/features/quick-tabs/handlers/CreateHandler.js (167 lines) encapsulating Quick Tab creation logic with validation and persistence.
- [x] **Extract UpdateHandler** - Create src/features/quick-tabs/handlers/UpdateHandler.js (141 lines) handling position and size updates with debouncing.
- [x] **Extract VisibilityHandler** - Create src/features/quick-tabs/handlers/VisibilityHandler.js (238 lines) managing solo/mute/minimize operations.
- [x] **Extract DestroyHandler** - Create src/features/quick-tabs/handlers/DestroyHandler.js (155 lines) coordinating cleanup logic for closing Quick Tabs.

#### Coordinators (Orchestration) âœ…

- [x] **Extract UICoordinator** - Create src/features/quick-tabs/coordinators/UICoordinator.js (182 lines) rendering QuickTabWindow instances from QuickTab entities and managing lifecycle.
- [x] **Extract SyncCoordinator** - Create src/features/quick-tabs/coordinators/SyncCoordinator.js (145 lines) routing broadcast messages and coordinating storage â†” state sync.

### Phase 2.2: Facade Integration âœ… COMPLETE

#### Facade Implementation âœ…

- [x] **Create QuickTabsManager facade** - Refactor src/features/quick-tabs/QuickTabsManager/index.js from 1453 lines to 529 lines by delegating to extracted components.
- [x] **Wire component dependencies** - Inject dependencies (StateManager, StorageManager, etc.) into facade constructor for loose coupling.
- [x] **Maintain public API** - Ensure all existing public methods delegate to appropriate components without breaking consumers.
- [x] **Reduce complexity metrics** - Achieve mean cc <3, max cc <9, all methods <70 lines (from cc mean 6.74, max 25).

### Phase 2.3-2.7: ESLint Cleanup & Pattern Demonstration â³ IN PROGRESS (85%)

#### Import Ordering & Basic Fixes âœ… COMPLETE

- [x] **Fix content.js import ordering** - Resolve 12 ESLint errors related to import statement organization (Phase 2.3)
- [x] **Add missing semicolons** - Fix punctuation-related ESLint warnings across codebase (Phase 2.3)

#### Complexity Reduction Demonstrations âœ… COMPLETE

- [x] **Create ResizeHandle component** - Build src/features/quick-tabs/window/ResizeHandle.js (281 lines) with table-driven configuration for 8 resize directions, reducing complexity from cc=25 to cc=3 (Phase 2.3)
- [x] **Create ResizeController facade** - Build src/features/quick-tabs/window/ResizeController.js (60 lines) to replace 195-line setupResizeHandlers method (Phase 2.3)
- [x] **Add comprehensive tests** - Write 22 tests for ResizeHandle/ResizeController components with 100% coverage (Phase 2.3)

#### ESLint Warning Reduction â³ IN PROGRESS

- [x] **Phase 2.4-2.5:** Initial warning reduction (88 â†’ 82 warnings, -7%) - Window.js and basic cleanup
- [x] **Phase 2.6:** Major warning reduction (82 â†’ 36 warnings, -56%) - Systematic unused variable cleanup, no-return-await fixes, 40 warnings eliminated
- [x] **Phase 2.7:** Continued warning reduction (36 â†’ 32 warnings, -11%) - Genuine require-await fixes, remaining unused variables
- [ ] **Phase 2.8 (Next):** Target <30 warnings - Continue systematic cleanup

#### ESLint Error Reduction â³ IN PROGRESS

- [x] **Phase 2.6:** Minor error reduction (83 â†’ 79 errors, -5%) - Fixed debug import in social-media.js
- [ ] **Remaining 79 errors:** 51 in background.js alone (65% of all errors), requires dedicated 8+ hour session with handler registry pattern

### Phase 2.4: Window Component Integration

#### QuickTabWindow Refactor

- [ ] **Integrate ResizeController** - Replace existing resize logic in QuickTabWindow with ResizeController facade, reducing complexity by 195 lines.
- [ ] **Extract DragController** - Create src/features/quick-tabs/window/DragController.js to encapsulate drag logic with proper mouse tracking (prevent "slipping" on high-refresh monitors).
- [ ] **Create WindowStyler component** - Extract styling logic (dark mode, themes, animations) into dedicated component.
- [ ] **Add WindowFactory** - Implement factory pattern for creating QuickTabWindow instances with proper dependency injection.

### Phase 2.5: Quick Tabs Feature Completion

#### Manager Panel Component

- [ ] **Extract ManagerPanelUI** - Create src/features/quick-tabs/manager/ManagerPanelUI.js for the minimized tabs manager interface.
- [ ] **Create ManagerPanelController** - Coordinate restore/delete operations for minimized Quick Tabs.
- [ ] **Add ManagerPanelState** - Manage visibility and persistence of manager panel across tabs.

#### Navigation Components

- [ ] **Create NavigationBar component** - Extract Quick Tab titlebar with navigation buttons (back/forward/reload) into reusable component.
- [ ] **Create TitleUpdater** - Handle dynamic title and favicon updates based on iframe content.

---

## Phase 3: Background Script Refactor

This phase transforms background.js from a monolithic event handler into a coordinator of specialized services.

### Phase 3.1: Service Extraction

#### State Services

- [ ] **Extract TabStateService** - Create src/background/services/TabStateService.js to manage Quick Tab state per browser tab with Map-based storage.
- [ ] **Extract ContainerService** - Create src/background/services/ContainerService.js to handle Firefox Container operations and cookieStoreId management.

#### Communication Services

- [ ] **Extract MessageRouter** - Create src/background/services/MessageRouter.js to route runtime.onMessage calls to appropriate handlers based on message.action.
- [ ] **Extract StorageService** - Create src/background/services/StorageService.js as facade for browser.storage operations with quota management.

#### Feature Services

- [ ] **Extract ClipboardService** - Create src/background/services/ClipboardService.js to handle copy operations from content scripts.
- [ ] **Extract TabOpenerService** - Create src/background/services/TabOpenerService.js for opening links in new tabs with focus control.

### Phase 3.2: Background Coordinator

#### Coordinator Implementation

- [ ] **Create BackgroundCoordinator** - Build src/background/BackgroundCoordinator.js as lightweight facade delegating to extracted services.
- [ ] **Wire service dependencies** - Use constructor injection to provide loose coupling between services.
- [ ] **Implement lifecycle management** - Add init() method to setup all service listeners and startup() for initial state loading.

---

## Phase 4: Content Script Refactor

This phase modularizes content.js by separating URL detection, UI rendering, and event handling concerns.

### Phase 4.1: URL Detection System

#### Site Handler Refactor

- [ ] **Extract SiteHandlerRegistry** - Create src/content/url-detection/SiteHandlerRegistry.js managing 100+ site-specific handlers with lazy loading.
- [ ] **Create AbstractSiteHandler base class** - Define interface for site handlers (detect(), extractUrl(), getPriority()) to standardize handler implementations.
- [ ] **Refactor generic handler** - Extract src/content/url-detection/handlers/GenericHandler.js as fallback for sites without specific handlers.
- [ ] **Implement handler composition** - Allow combining multiple handlers (e.g., Twitter handler + generic link detection) using composite pattern.

#### Detection Pipeline

- [ ] **Create HoverDetectionPipeline** - Build src/content/url-detection/HoverDetectionPipeline.js to coordinate mouseover events â†’ handler selection â†’ URL extraction flow.
- [ ] **Add caching layer** - Implement memoization for repeated hover detection on same element to improve performance.

### Phase 4.2: UI Rendering System

#### Notification Refactor

- [ ] **Extract NotificationRenderer** - Create src/content/ui/NotificationRenderer.js handling tooltip/notification display with animations.
- [ ] **Create NotificationStyler** - Build src/content/ui/NotificationStyler.js for applying user-configured styles (position, size, color, border).
- [ ] **Extract AnimationController** - Create src/content/ui/AnimationController.js for slide/pop/fade animations with configurable timing.

#### Manager Integration

- [ ] **Create UIManager facade** - Build src/content/ui/UIManager.js as single entry point for all content script UI operations.
- [ ] **Wire rendering pipeline** - Connect hover detection â†’ URL extraction â†’ notification rendering â†’ Quick Tab creation flow through UIManager.

### Phase 4.3: Event Handling System

#### Event Coordinators

- [ ] **Extract KeyboardEventHandler** - Create src/content/events/KeyboardEventHandler.js for copy/text/open-tab shortcuts with modifier key detection.
- [ ] **Extract MouseEventHandler** - Create src/content/events/MouseEventHandler.js for mouseover/mouseout with debouncing.
- [ ] **Create EventCoordinator** - Build src/content/events/EventCoordinator.js to manage all event listeners and prevent memory leaks.

---

## Phase 5: Popup/Options UI Refactor

This phase modularizes the settings UI by separating form handling, validation, and storage synchronization.

### Phase 5.1: Settings Management

#### Settings Components

- [ ] **Extract SettingsManager** - Create src/popup/SettingsManager.js as facade for loading/saving/resetting settings via browser.storage.
- [ ] **Create SettingsValidator** - Build src/popup/SettingsValidator.js for validating hex colors, numeric ranges, and enum values.
- [ ] **Extract FormController** - Create src/popup/FormController.js to coordinate form elements â†” settings data binding.

### Phase 5.2: UI Components

#### Tab System

- [ ] **Create TabNavigator** - Extract src/popup/TabNavigator.js for switching between Copy URL/Quick Tabs/Appearance/Advanced tabs.
- [ ] **Extract ColorPicker component** - Build src/popup/components/ColorPicker.js for hex input with live preview.
- [ ] **Create DropdownController** - Extract src/popup/components/DropdownController.js for select elements with custom styling.

### Phase 5.3: Options Page

#### Options Refactor

- [ ] **Mirror popup architecture** - Apply same component extraction pattern to options_page.js for consistency.
- [ ] **Create OptionsCoordinator** - Build facade similar to SettingsManager for options page specific logic.

---

## Phase 6: Shared Utilities & Helpers

This phase extracts common utility functions into reusable modules to reduce duplication.

### Phase 6.1: Core Utilities

#### Utility Modules

- [ ] **Create DOMUtils** - Extract src/shared/utils/DOMUtils.js for createElement, classList, event delegation helpers.
- [ ] **Create ValidationUtils** - Build src/shared/utils/ValidationUtils.js for URL validation, hex color validation, type checking.
- [ ] **Create StringUtils** - Create src/shared/utils/StringUtils.js for text truncation, sanitization, formatting.
- [ ] **Create MathUtils** - Build src/shared/utils/MathUtils.js for viewport clamping, position calculation, bounds checking.

### Phase 6.2: Browser API Wrappers

#### API Facades

- [ ] **Create StorageFacade** - Build src/shared/facades/StorageFacade.js wrapping browser.storage with consistent error handling.
- [ ] **Create MessageFacade** - Create src/shared/facades/MessageFacade.js wrapping browser.runtime.sendMessage with type safety.
- [ ] **Create TabsFacade** - Build src/shared/facades/TabsFacade.js wrapping browser.tabs with promise-based API.

---

## Phase 7: Testing & Documentation

This phase ensures comprehensive test coverage and clear documentation for the refactored architecture.

### Phase 7.1: Test Coverage

#### Unit Tests

- [ ] **Achieve 100% domain layer coverage** - Add tests for any uncovered edge cases in QuickTab and Container entities.
- [ ] **Achieve 90% storage layer coverage** - Ensure all storage adapter branches are tested including error cases.
- [ ] **Achieve 80% feature coverage** - Write tests for QuickTabsManager components, handlers, and coordinators.

#### Integration Tests

- [ ] **Create cross-component integration tests** - Test complete flows (create Quick Tab â†’ persist â†’ sync â†’ render) across component boundaries.
- [ ] **Add browser API integration tests** - Test storage adapters against mock browser.storage with realistic scenarios.

### Phase 7.2: Documentation

#### Architecture Documentation

- [ ] **Create architecture decision records (ADRs)** - Document key refactoring decisions (facade pattern, strategy pattern) in docs/architecture/.
- [ ] **Update README with new architecture** - Explain Domain-Driven Design structure, component responsibilities, and data flow.
- [ ] **Create developer guide** - Write docs/DEVELOPER-GUIDE.md explaining how to add new features in the refactored architecture.

#### Code Documentation

- [ ] **Add JSDoc comments to public APIs** - Document all public methods with @param, @returns, @throws tags.
- [ ] **Create module README files** - Add README.md in each major directory (src/domain/, src/features/, src/background/) explaining module purpose.

---

## Completion Criteria

### Quality Metrics (Updated 2025-01-18)

- âœ… Domain Layer: 100% coverage (currently 100%) âœ… ACHIEVED
- âœ… Storage Layer: 90% coverage (currently 92.26%) âœ… ACHIEVED
- â³ Feature Layer: 80% coverage (currently ~60%, need 20% more)
- â³ ESLint: 0 errors (currently 79, need to fix 79) - **51 errors in background.js alone**
- â³ ESLint: 0 warnings (currently 32, down from 88, -64% progress) - **Target: <30 next**
- â³ Complexity: All cc â‰¤ 9 (need to refactor background.js cc=93 function)
- â³ Line length: All functions â‰¤ 70 lines (need to split window.js:createTitlebar 157 lines)

### Functional Requirements

- âœ… 100% backward compatibility maintained
- âœ… All user-facing features work identically
- âœ… Settings and storage format remain compatible
- âœ… Firefox and Zen Browser compatibility preserved
- â³ Performance equals or exceeds current implementation (need to measure)

### Documentation Requirements

- â³ All public APIs documented with JSDoc
- â³ Architecture diagrams created
- â³ Developer guide complete
- â³ Migration guide for contributors

---

## Progress Summary

**Overall Progress: ~43%** (updated 2025-01-18)

| Phase                            | Status         | Progress | Details                                 |
| -------------------------------- | -------------- | -------- | --------------------------------------- |
| Phase 0: Infrastructure          | âœ… Complete    | 100%     | Build, test, CI/CD setup                |
| Phase 1: Domain + Storage        | âœ… Complete    | 100%     | QuickTab, Container, adapters           |
| Phase 2.1: Component Extraction  | âœ… Complete    | 100%     | Managers, handlers, coordinators        |
| Phase 2.2: Facade Integration    | âœ… Complete    | 100%     | QuickTabsManager facade                 |
| Phase 2.3-2.7: ESLint Cleanup    | â³ In Progress | 85%      | 88 â†’ 32 warnings (-64%), 83 â†’ 79 errors |
| Phase 2.4: Window Components     | ðŸ“ Not Started | 0%       | ResizeController integration pending    |
| Phase 2.5: Quick Tabs Completion | ðŸ“ Not Started | 0%       | Manager panel, navigation components    |
| Phase 3: Background Refactor     | ðŸ“ Not Started | 0%       | Message handler registry (8+ hours)     |
| Phase 4: Content Script Refactor | ðŸ“ Not Started | 0%       | URL detection, UI rendering             |
| Phase 5: Popup/Options Refactor  | ðŸ“ Not Started | 0%       | Settings management UI                  |
| Phase 6: Utilities               | ðŸ“ Not Started | 0%       | Shared utility modules                  |
| Phase 7: Testing & Docs          | ðŸ“ Not Started | 0%       | Coverage goals, architecture docs       |

**Next Priority:** Complete Phase 2.3-2.7 ESLint cleanup to <30 warnings, then proceed to Phase 2.4 Window Components or Phase 3 Background Refactor (requires dedicated 8+ hour session).

---

## How Copilot Agents Should Use This Checklist

### For refactor-specialist Agent

1. **At start of session**: Read this checklist to understand current progress
2. **Select work items**: Choose items from current phase (Phase 2.3 now) or next phase if current is blocked
3. **Update checklist**: After completing work, mark items as [x] and update Progress Summary
4. **Report status**: Use checklist items as basis for commit messages and PR descriptions

### For other agents

- **bug-fixer**: Check if bugs are related to refactored components before fixing
- **feature-builder**: Coordinate with refactor-specialist to avoid conflicts
- **master-orchestrator**: Use checklist to delegate work between agents

### Checklist Update Process

1. Mark completed items with [x]
2. Update "Last Updated" date at top
3. Recalculate "Overall Progress" percentage
4. Update "Progress Summary" table
5. Update "Next Priority" statement
6. Commit changes with descriptive message

---

## Notes

- **Token Efficiency**: This checklist reduces documentation verbosity by consolidating all phase information into one file
- **Evidence-Based**: All items derived from Mozilla/Chrome best practices and CodeScene analysis
- **Flexible**: Items can be completed out of order if dependencies allow
- **Living Document**: Expected to evolve as refactoring reveals new requirements
- **Agent-Friendly**: Structured for easy parsing by Copilot Coding Agent
