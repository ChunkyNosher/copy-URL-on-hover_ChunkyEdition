# v1.6.0 Refactoring Phase 7.9 - Next Steps

**Date:** 2025-11-19  
**Session:** 17  
**Previous Session:** Phase 7.8 - URL Handler Tests + Code Health Validation  
**Current Status:** 87% overall progress, Overall coverage at 75.26% statements

---

## Executive Summary

Session 16 (Phase 7.8) achieved significant progress:

- **Fixed ESLint error** (no-script-url in test)
- **Added 133 comprehensive URL handler tests** (social-media: 53, developer:
  48, video: 32)
- **Overall coverage:** 69.6% → 75.26% statements (+5.66%), 64.05% → 70.46%
  branches (+6.41%)
- **URL handlers:** social-media 100% ✅, developer 100% ✅, video 100% ✅
- **Code health validated:** All refactored components 8.54-10.0 (exceeds 8.0
  target) ✅
- **Overall progress:** 86% → 87%

**Remaining work:** Feature layer at 75.26% statements/70.46% branches (target:
80% statements/75% branches)

---

## Priority 1: Close Feature Layer Coverage Gap (4.74% statements, 4.54% branches needed)

### High-Impact Coverage Opportunities

**1. Remaining URL Handlers - Site-Specific Functions**

- **Impact:** Medium-High (+1.5-2% feature coverage)
- **Files:** `src/features/url-handlers/` (6 untested handler files)
- **Current:** 0% coverage for blogging.js, ecommerce.js, entertainment.js,
  gaming.js, image-design.js, learning.js, news-discussion.js, other.js
- **Target:** 50%+ coverage for commonly-used handlers
- **Recommended approach:**
  - Create `tests/unit/url-handlers/NewsDiscussionHandlers.test.js` (HackerNews,
    Reddit discussions, etc.)
  - Create `tests/unit/url-handlers/EcommerceHandlers.test.js` (Amazon, eBay,
    etc.)
  - Test 3-4 most common handlers per category
  - Focus on realistic DOM structures and edge cases
- **Estimated tests:** ~40-60 tests
- **Estimated coverage gain:** +1.5-2%

**2. UI Components - Branch Coverage Improvements**

- **Impact:** Medium (+0.8-1.2% feature coverage)
- **Files:** `src/features/notifications/Toast.js`,
  `src/features/notifications/Tooltip.js`
- **Current:** 100% line coverage, but ~65-70% branch coverage
- **Target:** Increase branch coverage to 80%+
- **Recommended approach:**
  - Add tests for rare animation states (interrupted animations, rapid show/hide
    cycles)
  - Test concurrent toast/tooltip creation
  - Test extreme positioning scenarios (viewport edges, very small screens)
  - Test cleanup with orphaned elements
  - Test error recovery paths
- **Estimated tests:** ~15-20 tests
- **Estimated coverage gain:** +0.8-1.2%

**3. Panel Resize/Drag Controllers - Uncovered Branches**

- **Impact:** Medium (+0.5-0.8% feature coverage)
- **Files:** `src/features/quick-tabs/panel/PanelResizeController.js`,
  `src/features/quick-tabs/panel/PanelDragController.js`
- **Current:** 98.27% and 100% line coverage, but branch coverage gaps
- **Target:** Close all uncovered branches
- **Recommended approach:**
  - Test boundary conditions (min/max size constraints hit)
  - Test viewport edge snapping behavior
  - Test concurrent resize + drag operations
  - Test cleanup on rapid state changes
  - Test pointer capture loss scenarios
- **Estimated tests:** ~15-20 tests
- **Estimated coverage gain:** +0.5-0.8%

**4. StateCoordinator Integration Tests (Deferred from Phase 3.2)**

- **Impact:** Medium (+0.8-1% feature coverage)
- **File:** `src/background/coordinators/StateCoordinator.js`
- **Current:** Limited integration testing
- **Target:** Full integration test suite
- **Recommended approach:**
  - Test batch update scenarios (multiple Quick Tabs created simultaneously)
  - Test storage sync race conditions
  - Test container isolation during state operations
  - Test error recovery (storage failures, corrupted state)
  - Test state persistence across browser restarts (mock session storage)
  - Test vector clock conflict resolution
- **Estimated tests:** ~25-35 tests
- **Estimated coverage gain:** +0.8-1%

---

## Priority 2: End-to-End Flow Tests with Playwright

**Create Integration Tests for Complete Workflows:**

**1. Quick Tab Lifecycle Test**

- Test: Create → Update Position → Update Size → Minimize → Restore → Close
- Verify: Storage sync, BroadcastChannel messaging, UI updates, cleanup
- Test containers: Verify isolation (operations in container-1 don't affect
  container-2)
- **File:** `tests/extension/quick-tab-lifecycle.test.js`
- **Scenarios:** 5-7 complete workflows

**2. Solo/Mute Workflow Test**

- Test: Create Quick Tab → Solo on Tab A → Verify hidden on Tab B → Unsolo →
  Verify visible everywhere
- Test: Create Quick Tab → Mute on Tab C → Verify hidden on Tab C only → Unmute
- Verify: Mutual exclusivity (solo clears mute, mute clears solo)
- **File:** `tests/extension/solo-mute-workflow.test.js`
- **Scenarios:** 3-5 workflows

**3. Manager Panel Workflow Test**

- Test: Open panel → Create Quick Tab → Panel auto-updates → Minimize from panel
  → Panel reflects change
- Verify: Real-time synchronization between panel and Quick Tabs
- **File:** `tests/extension/manager-panel-workflow.test.js`
- **Scenarios:** 4-6 workflows

**Estimated tests:** ~15-20 E2E tests  
**Value:** High (validates real-world usage, catches integration bugs)

---

## Priority 3: Performance Validation

**Measure and Document Performance:**

**1. Storage Operation Latency**

- Measure: save(), load(), delete() operation times
- Target: <100ms for typical operations
- Document: Average, P95, P99 latencies
- **Create:** `tests/performance/storage-latency.test.js`

**2. BroadcastChannel Message Latency**

- Measure: Time from broadcast to receipt in other tabs
- Target: <10ms for same-origin tabs
- Document: Cross-tab sync performance
- **Create:** `tests/performance/broadcast-latency.test.js`

**3. Quick Tab Render Time**

- Measure: Time from creation to visible render
- Target: <50ms for initial render
- Document: Render pipeline performance
- **Create:** `tests/performance/render-time.test.js`

**4. Panel Refresh Performance**

- Measure: Time to refresh panel content
- Target: <100ms for typical state
- Document: Scaling behavior (1 tab vs 50 tabs)
- **Create:** `tests/performance/panel-refresh.test.js`

---

## Priority 4: Documentation Updates

**1. Architecture Documentation**

- Document Domain-Driven Design structure
- Create component interaction diagrams
- Document data flow (creation → storage → sync → render)
- Document container isolation architecture
- **Create:** `docs/architecture/` directory with diagrams

**2. Update README.md**

- Add v1.6.0 refactoring highlights
- Document new architecture benefits
- Update developer setup instructions
- Add testing guide
- Link to architecture documentation

**3. API Documentation**

- Add JSDoc comments to all public methods
- Document facade patterns (QuickTabsManager, PanelManager)
- Document handler interfaces (CreateHandler, UpdateHandler, etc.)
- Document coordinator responsibilities
- **Target:** 100% JSDoc coverage for public APIs

---

## Implementation Strategy for Next Agent

### Session Workflow

**1. Start (5 minutes)**

- Read this document completely
- Check master checklist for updates
- Run tests to verify starting state: `npm test && npm run test:coverage`

**2. Work Priority (Token Budget Permitting)**

**If tokens > 500k:**

- Priority 1: Remaining URL handler tests (highest impact, +1.5-2%)
- Priority 1: UI component branch coverage (+0.8-1.2%)
- Priority 1: Panel controller edge cases (+0.5-0.8%)
- Priority 1: StateCoordinator integration tests (+0.8-1%)
- Priority 2: End-to-end tests (high value)
- Priority 3: Performance validation
- Priority 4: Update documentation

**If tokens 200k-500k:**

- Priority 1: Remaining URL handler tests (focus on news-discussion, ecommerce)
- Priority 1: UI component branch coverage
- Priority 2: End-to-end tests (Quick Tab lifecycle only)
- Priority 4: Update master checklist

**If tokens < 200k:**

- Priority 1: Remaining URL handler tests (news-discussion only)
- Priority 1: UI component branch coverage (Toast only)
- Priority 4: Update master checklist

**3. End (MANDATORY)**

- Run full test suite: `npm test`
- Check coverage: `npm run test:coverage | tail -50`
- Update master checklist with completed work
- Commit all changes
- Create Phase 7.10 next-steps document (if work remains)

### Success Criteria

**Minimum Success (Low Token Budget):**

- +2% feature layer coverage
- Remaining URL handler tests for 2+ categories
- Master checklist updated

**Target Success (Medium Token Budget):**

- +4% feature layer coverage
- Remaining URL handler tests complete
- UI component branch coverage improved
- E2E tests for Quick Tab lifecycle
- Master checklist updated

**Stretch Success (High Token Budget):**

- +6% feature layer coverage
- All Priority 1-2 items complete
- Feature layer reaches 81%+ statements (exceeds 80% target)
- E2E tests complete
- Performance validation complete
- Master checklist + documentation updated

---

## File Locations Reference

### Test Files to Create/Modify

- `tests/unit/url-handlers/NewsDiscussionHandlers.test.js` (CREATE)
- `tests/unit/url-handlers/EcommerceHandlers.test.js` (CREATE)
- `tests/unit/url-handlers/EntertainmentHandlers.test.js` (CREATE - if time)
- `tests/unit/notifications/ToastBranchCoverage.test.js` (CREATE)
- `tests/unit/notifications/TooltipBranchCoverage.test.js` (CREATE)
- `tests/unit/panel/PanelControllerEdgeCases.test.js` (CREATE)
- `tests/integration/StateCoordinatorIntegration.test.js` (CREATE)
- `tests/extension/quick-tab-lifecycle.test.js` (CREATE)
- `tests/extension/solo-mute-workflow.test.js` (CREATE - if time)
- `tests/extension/manager-panel-workflow.test.js` (CREATE - if time)

### Documentation Files to Update

- `docs/misc/v1.6.0-REFACTORING-MASTER-CHECKLIST.md` (UPDATE - MANDATORY)
- `README.md` (UPDATE - defer to later if low tokens)
- `docs/architecture/` (CREATE - defer to later)

### Coverage Target Files

- `src/features/url-handlers/news-discussion.js` (0% → 50%+)
- `src/features/url-handlers/ecommerce.js` (0% → 50%+)
- `src/features/notifications/Toast.js` (branch coverage: ~70% → 80%+)
- `src/features/notifications/Tooltip.js` (branch coverage: ~70% → 80%+)
- `src/features/quick-tabs/panel/PanelResizeController.js` (uncovered branches)
- `src/features/quick-tabs/panel/PanelDragController.js` (uncovered branches)
- `src/background/coordinators/StateCoordinator.js` (integration tests)

---

## Notes for Future Sessions

### Known Issues/Tech Debt

- ESLint warnings remaining: 2 (max-lines-per-function in popup.js and window.js
  render)
  - These are acceptable - refactoring these would be risky
  - Can be addressed in future major refactor if needed
- Playwright tests excluded from Jest (TransformStream incompatibility)
  - Tests work but can't run with Jest
  - Consider separate test:e2e script for Playwright
- Global coverage thresholds not met yet (40.4% vs 80% target)
  - Need to test: popup.js, options_page.js, state-manager.js, utils files
  - Defer to Phase 8 (these are outside feature layer scope)

### Testing Patterns Established

- **Edge case tests:** Focus on error paths, null/undefined inputs, boundary
  conditions
- **Integration tests:** Mock dependencies minimally, test real interactions
- **Coverage strategy:** Close line coverage first, then branch coverage
- **Test file organization:** Group by component, separate edge cases into
  dedicated files
- **URL handler tests:** Test DOM structure traversal, selector matching,
  fallback to generic

### Refactoring Principles Maintained

- **Zero breaking changes:** All v1.5.9.x features preserved
- **Container isolation:** All operations respect cookieStoreId boundaries
- **Storage format:** Backward compatible with v1.5.8.15+
- **Code health:** Target 8.0+ for all refactored components (currently
  8.54-10.0) ✅ ACHIEVED
- **ESLint compliance:** 0 errors maintained throughout

---

## Coverage Gap Analysis

**Current Feature Layer Coverage:** 75.26% statements, 70.46% branches  
**Target:** 80% statements, 75% branches  
**Gap:** +4.74% statements, +4.54% branches

**Estimated Test Requirements to Close Gap:**

- Remaining URL handlers: ~50 tests (+1.5-2%)
- UI component branches: ~20 tests (+0.8-1.2%)
- Panel controller edges: ~18 tests (+0.5-0.8%)
- StateCoordinator integration: ~30 tests (+0.8-1%)
- **Total:** ~118 tests needed to reach 80%/75% target

**Feasibility:** Achievable in 1-2 sessions with focused effort

---

## End of Phase 7.9 Next Steps

**This document will be replaced by Phase 7.10 next-steps when work is
complete.**

**Current session should aim for:** Feature layer 75.26% → 80%+ statements,
70.46% → 75%+ branches (meet/exceed targets)
