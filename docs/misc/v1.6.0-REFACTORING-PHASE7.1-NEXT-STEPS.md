# v1.6.0 Refactoring Phase 7.1 - Feature Layer Test Coverage Next Steps

**Date Created:** 2025-11-19  
**Current Status:** Phase 7 In Progress (78% overall, 56.2% feature layer
coverage)  
**Previous Work:** Session 10 - window.js 86.38% coverage (89 tests),
minimized-manager.js 100% coverage (40 tests). Tests: 971/973 passing. ESLint: 0
errors, 2 warnings.  
**Repository:** copy-URL-on-hover_ChunkyEdition  
**Branch:** copilot/continue-refactoring-project-\*

---

## Executive Summary

Session 10 **SUCCESSFUL** - Added 129 tests, improved feature layer coverage by
4.2%. Two components fully tested: window.js (86.38%) and minimized-manager.js
(100%). Code health excellent across all components (8.0+).

**Current Metrics:**

- ESLint errors: 0 ✅
- ESLint warnings: 2 (acceptable - render methods)
- Tests: 971/973 passing ✅
- Code health: 8.0-10.0 across tested components ✅
- Feature layer coverage: 56.2% (need 80%)
- Overall progress: 78%

**Critical Gap:** Feature layer coverage at 56.2%, need to reach 80%+ target.
Major untested components: ResizeController, notifications system, panel
integration.

**Recommendation:** Focus on high-impact test additions. Prioritize
ResizeController (used by all Quick Tabs), notifications (user-facing), then
panel integration.

---

## Priority 1: ResizeController Tests - HIGHEST PRIORITY

**Goal:** Achieve 80%+ coverage on ResizeController.js

### Why Priority #1

- **Used by every Quick Tab window** - Core functionality
- **Complex logic** - 8 resize directions, viewport clamping, min dimensions
- **Currently 0% coverage** - High-impact opportunity
- **Already has companion tests** - ResizeHandle has 98.7% coverage, provides
  pattern to follow

### Current Status

**File:** `src/features/quick-tabs/window/ResizeController.js`  
**Coverage:** 0%  
**Lines:** ~60 lines (facade pattern)  
**Complexity:** Low (cc<4) - delegates to ResizeHandle

### Implementation Strategy

#### Test File Location

Create: `tests/unit/window/ResizeController.test.js`

#### Test Coverage Areas

1. **Constructor and Initialization**
   - Window reference assignment
   - Min dimensions configuration (minWidth, minHeight)
   - Handle references initialization

2. **attachHandles() Method**
   - Creates 8 ResizeHandle instances (n, s, e, w, ne, nw, se, sw)
   - Configures each handle with correct direction
   - Passes window reference and callbacks
   - Stores handle references

3. **detachAll() Method**
   - Calls destroy() on all handle instances
   - Clears handle references
   - Handles when no handles attached

4. **Integration with ResizeHandle**
   - Verifies ResizeHandle constructor called 8 times
   - Verifies correct direction passed to each handle
   - Verifies callbacks (onResizeStart, onResize, onResizeEnd) wired correctly

5. **Edge Cases**
   - Multiple attachHandles() calls (should be idempotent or clear previous)
   - detachAll() before attachHandles()
   - Null/undefined window reference

### Test Pattern to Follow

Reference `tests/unit/window/ResizeHandle.test.js` (98.7% coverage) for:

- Mock structure (ResizeHandle mocks)
- Test organization (describe blocks)
- Callback testing patterns
- Edge case coverage

### Expected Outcome

- **Coverage:** 80%+ (target)
- **Tests:** ~25-30 tests (similar to ResizeHandle)
- **Time:** 1-2 hours
- **Impact:** High (core Quick Tab functionality)

---

## Priority 2: Notifications System Tests - HIGH PRIORITY

**Goal:** Achieve 70%+ coverage on notifications system

### Why Priority #2

- **User-facing feature** - Visible feedback for copy operations
- **Three interrelated modules** - index.js (manager), toast.js, tooltip.js
- **Currently 0% coverage** - 321 lines total untested
- **Moderate complexity** - DOM manipulation, animations, positioning

### Current Status

**Files:**

- `src/features/notifications/index.js` (192 lines) - Notification manager
- `src/features/notifications/toast.js` (70 lines) - Toast notifications
- `src/features/notifications/tooltip.js` (59 lines) - Tooltip notifications

**Coverage:** 0% across all three files

### Implementation Strategy

#### Test File Locations

Create:

- `tests/unit/notifications/NotificationManager.test.js`
- `tests/unit/notifications/Toast.test.js`
- `tests/unit/notifications/Tooltip.test.js`

#### 1. NotificationManager Tests (index.js)

**Test Coverage:**

1. **showNotification() Method**
   - Routes to toast vs tooltip based on config
   - Handles notification type parameter
   - Manages notification queue
   - Applies auto-dismiss timers

2. **Notification Lifecycle**
   - Creation → Display → Auto-dismiss
   - Manual dismiss
   - Queue management (multiple notifications)

3. **Configuration Integration**
   - Reads from ConfigManager
   - Respects user preferences (position, duration, enabled/disabled)

4. **Edge Cases**
   - Null/empty message
   - Missing configuration
   - Rapid notification calls (queue overflow)

#### 2. Toast Notification Tests (toast.js)

**Test Coverage:**

1. **Toast Creation**
   - DOM element creation
   - Style application (position, colors, dimensions)
   - Content rendering (message, icon)

2. **Positioning Logic**
   - Top-left, top-right, bottom-left, bottom-right
   - Viewport boundary respect
   - Multiple toast stacking

3. **Animation**
   - Fade-in animation
   - Auto-dismiss after duration
   - Fade-out animation
   - Animation cleanup

4. **Dismiss Handling**
   - Click to dismiss
   - Auto-dismiss timer
   - Animation completion
   - DOM element removal

#### 3. Tooltip Notification Tests (tooltip.js)

**Test Coverage:**

1. **Tooltip Creation**
   - DOM element creation
   - Style application
   - Content formatting

2. **Mouse Tracking**
   - Follows mouse cursor
   - Offset from cursor (prevent occlusion)
   - Viewport boundary clamping

3. **Show/Hide Transitions**
   - Fade-in on show
   - Fade-out on hide
   - Position updates during movement

4. **Content Formatting**
   - URL formatting
   - Text truncation
   - Special character handling

### Testing Approach

**Mock Strategy:**

- Mock DOM createElement, appendChild, removeChild
- Mock setTimeout, clearTimeout for animation timing
- Mock ConfigManager for notification preferences
- Use JSDOM for basic DOM manipulation verification

**Focus:**

- Test **logic** (notification routing, positioning, lifecycle), not
  pixel-perfect rendering
- Verify **correct method calls** (createElement with right params)
- Test **state management** (notification queue, timers)
- Validate **data transformations** (message formatting)

### Expected Outcome

- **Coverage:** 70%+ across all three files (target)
- **Tests:** ~60-70 tests total (20-25 per file)
- **Time:** 2-3 hours
- **Impact:** High (user-visible feature)

---

## Priority 3: Panel Integration Tests - MEDIUM PRIORITY

**Goal:** Achieve 60%+ coverage on panel.js (facade)

### Why Priority #3 (Not Higher)

- **Facade pattern** - Delegates to 5 tested components
- **Components already tested** - PanelUIBuilder, PanelDragController, etc. at
  90%+ coverage
- **Integration-level tests** - Lower ROI than unit tests
- **Time-consuming** - Need to mock 5 components and their interactions

### Current Status

**File:** `src/features/quick-tabs/panel.js` (408 lines)  
**Coverage:** 0%  
**Pattern:** Facade delegates to 5 panel components

**Underlying Components (Already Tested):**

- PanelUIBuilder: 90%+ coverage
- PanelDragController: 90%+ coverage
- PanelResizeController: 90%+ coverage
- PanelStateManager: 90%+ coverage
- PanelContentManager: 90%+ coverage

### Implementation Strategy

#### Test File Location

Create: `tests/unit/panel/PanelIntegration.test.js`

#### Test Coverage Areas

1. **Panel Lifecycle**
   - showPanel() creates UI, attaches controllers, loads state
   - hidePanel() cleans up controllers, hides UI
   - Panel visibility state persistence

2. **Component Delegation**
   - Verify PanelUIBuilder.build() called
   - Verify PanelDragController initialized with titlebar
   - Verify PanelResizeController initialized with window reference
   - Verify PanelStateManager.load() called
   - Verify PanelContentManager.render() called

3. **Quick Tab Operations**
   - Minimize/restore Quick Tab through panel
   - Close Quick Tab through panel
   - Navigate to Quick Tab URL
   - Edit Quick Tab URL

4. **Container Detection**
   - Correct cookieStoreId detection
   - Container-specific Quick Tab filtering
   - Cross-container isolation verification

5. **State Coordination**
   - Panel position/size persistence via PanelStateManager
   - BroadcastChannel sync via PanelStateManager
   - Quick Tab list updates via PanelContentManager

### Testing Approach

**Mock Strategy:**

- Mock all 5 panel components (PanelUIBuilder, PanelDragController, etc.)
- Mock browser.tabs.query for Quick Tab list
- Mock browser.storage for panel state
- Mock BroadcastChannel for cross-tab sync

**Focus:**

- Test **facade coordination** (correct method calls to components)
- Verify **component initialization** (all 5 components created)
- Test **event flow** (user action → component method → result)
- Validate **cleanup** (all components destroyed on hidePanel)

### Expected Outcome

- **Coverage:** 60%+ (target - facade delegates to tested components)
- **Tests:** ~30-40 tests
- **Time:** 1-2 hours
- **Impact:** Medium (validates component integration)

---

## Alternative: If Time Permits After Priorities 1-3

### Option A: URL Handlers Testing (LOW PRIORITY)

**Why Low Priority:**

- Site-specific logic (hard to test comprehensively)
- 1300+ lines across 12 handlers
- High time investment (4-6 hours minimum)
- Low coverage gain per hour invested

**Only test if:**

- All above priorities complete
- You have 4+ hours remaining
- Want to boost coverage metrics

**Test priority order:**

1. generic.js (60 lines) - Most-used fallback
2. developer.js (121 lines) - GitHub, GitLab, Stack Overflow
3. social-media.js (137 lines) - Twitter, Reddit, Facebook

**Expected Coverage:** 30-40% (site-specific logic difficult to test)

### Option B: Options Page Refactoring (ALTERNATIVE PATH)

**Why Alternative:**

- Architectural refactoring, not just testing
- options_page.js has high complexity (similar to popup.js)
- Would require extracting components (settings management, form handling, tab
  navigation)
- Aligns with Phase 5 goals (Popup/Options refactor)

**Only pursue if:**

- Feature layer coverage already at 75%+
- Want to reduce technical debt in options page
- Have 6+ hours remaining

**Not recommended** unless specifically requested by user.

---

## Testing Guidelines & Best Practices

### Mock DOM APIs

```javascript
// Mock browser APIs
global.browser = {
  storage: { sync: { get: jest.fn(), set: jest.fn() } },
  runtime: { sendMessage: jest.fn() }
};

// Mock DOM methods (JSDOM provides basic support)
global.requestAnimationFrame = jest.fn(cb => {
  cb();
  return 1;
});
global.cancelAnimationFrame = jest.fn();

// Mock timers
jest.useFakeTimers(); // For testing animations, auto-dismiss
```

### Test Structure Template

```javascript
describe('ComponentName', () => {
  let component;
  let mockDependencies;

  beforeEach(() => {
    // Setup mocks
    mockDependencies = {
      /* ... */
    };
    component = new Component(mockDependencies);

    // Mock console to avoid test output pollution
    jest.spyOn(console, 'log').mockImplementation();
  });

  afterEach(() => {
    jest.restoreAllMocks();
  });

  describe('methodName()', () => {
    test('should handle success case', () => {
      // Arrange
      const input = {
        /* ... */
      };

      // Act
      const result = component.methodName(input);

      // Assert
      expect(result).toBe(expected);
    });

    test('should handle error case', () => {
      // Test error paths
    });

    test('should handle edge case', () => {
      // Test edge cases
    });
  });
});
```

### Coverage Verification Commands

```bash
# Test specific file with coverage
npm test -- --coverage --collectCoverageFrom='src/path/to/file.js' tests/path/to/test.test.js

# Check feature layer coverage
npm test -- --coverage --collectCoverageFrom='src/features/**/*.js'

# Full coverage report
npm run test:coverage
```

### Code Health Verification

Use CodeScene tool after completing tests:

```javascript
// Via MCP tool
codescene - code_health_score({ file_path: '/absolute/path/to/file.js' });
```

Target: 8.0+ for all refactored files.

---

## Success Criteria for Phase 7.1 Completion

Phase 7.1 is **COMPLETE** when:

1. ✅ ResizeController.js: 80%+ coverage
2. ✅ Notifications system: 70%+ coverage (index.js, toast.js, tooltip.js)
3. ✅ Panel.js: 60%+ coverage (integration tests)
4. ✅ Feature layer: 75%+ overall coverage (currently 56.2%)
5. ✅ All tests passing: 971+/973+ (no regressions)
6. ✅ ESLint: 0 errors maintained
7. ✅ Code health: 8.0+ for all refactored components
8. ✅ Master checklist updated with completion status

**Target Metrics After Phase 7.1:**

- Feature layer coverage: 75%+ (from 56.2%, need +18.8%)
- Total tests: 1060+ passing (from 971, need +90 tests)
- ESLint: 0 errors, ≤2 warnings
- Code health: 8.0+ maintained

---

## Implementation Priority Order

**If you have 8+ hours:**

1. ResizeController tests (1-2 hours) - HIGHEST IMPACT ⚡
2. Notifications system tests (2-3 hours) - HIGH IMPACT
3. Panel integration tests (1-2 hours) - MEDIUM IMPACT
4. Update master checklist (15 minutes)
5. Create next NEXT-STEPS document (30 minutes)

**If you have 4-6 hours:**

1. ResizeController tests (1-2 hours)
2. Notifications system tests (2-3 hours)
3. Update master checklist (15 minutes)
4. Create next NEXT-STEPS document (30 minutes)

**If you have 2-3 hours:**

1. ResizeController tests (1-2 hours)
2. Partial notifications system tests (1 hour - focus on index.js)
3. Update master checklist (15 minutes)

---

## Important Notes

1. **DO NOT refactor code** unless it's broken or has code health <9.0
2. **FOCUS exclusively** on test coverage improvements
3. **MAINTAIN** 0 ESLint errors and 2 warnings (render methods)
4. **UPDATE** master checklist after completing each component
5. **VERIFY** all tests still pass after each change (run full suite)
6. **CHECK** code health with CodeScene tool after adding tests
7. **COMMIT** frequently with descriptive messages via report_progress
8. **FOLLOW** existing test patterns in tests/unit/ for consistency

---

## Reference Documentation

- **Master Checklist:** `docs/misc/v1.6.0-REFACTORING-MASTER-CHECKLIST.md`
- **Previous Session:** Phase 7 Session 10 (window.js, minimized-manager.js
  tests)
- **Refactoring Plan:**
  `docs/manual/1.5.9 docs/copy-url-on-hover-refactoring-plan-v2-evidence-based.md`
- **Infrastructure Guide:**
  `docs/manual/1.5.9 docs/infrastructure-testing-changes-refactoring.md`
- **Phase 4.5 Previous:** `docs/misc/v1.6.0-REFACTORING-PHASE4.5-NEXT-STEPS.md`

---

**END OF NEXT STEPS DOCUMENT**
