# Console Log Export - Feature Documentation

## Overview

The "Export Console Logs" debug feature captures console output from the extension for bug reporting and diagnostics.

## What Gets Captured

- ✅ All `console.log()` calls from extension code
- ✅ All `console.error()` calls from extension code
- ✅ All `console.warn()` calls from extension code
- ✅ All `console.info()` calls from extension code
- ✅ All `console.debug()` calls from extension code
- ✅ Uncaught exceptions in content scripts
- ✅ Unhandled promise rejections
- ✅ **Complete stack traces** from JavaScript errors (v1.6.0.4+)
- ✅ **Error causality chains** (`error.cause`)
- ✅ **File/line number information** from errors
- ✅ Timestamps for all log entries
- ✅ Execution context identification (content-script, background, popup)

## Known Limitations

The export feature **cannot** capture:

### 1. Browser-Generated Errors

Errors created by Firefox internally are not intercepted:

- `browser.runtime.lastError` warnings
- "Could not establish connection" messages when content scripts aren't loaded
- Browser API parameter validation errors

**Why:** These errors are logged directly to Browser Console by Firefox's internal code, bypassing JavaScript's `console` object.

### 2. Cross-Context Errors

Errors from isolated execution contexts:

- Errors in iframes (unless extension has access)
- Errors in web workers
- Errors in other extensions

**Why:** Each context has its own console and error handling.

### 3. Native Browser Errors

Browser-level errors bypass JavaScript console:

- Network request failures (CORS, CSP violations)
- Mixed content warnings
- Certificate errors

**Why:** These are browser infrastructure errors, not JavaScript runtime errors.

### 4. Pre-Initialization Errors

Errors that occur before the console interceptor loads:

- Module import errors
- Syntax errors in scripts
- Early initialization failures

**Why:** The interceptor must load before it can capture logs.

## Complete Diagnostic Workflow

To capture **all** diagnostic information when reporting bugs:

1. **Export Console Logs** (extension popup → Debug tab → Export Console Logs)
   - Captures extension JavaScript output with full stack traces

2. **Copy Browser Console Output** (Ctrl+Shift+J → Right-click → Copy All Messages)
   - Captures browser-generated errors

3. **Take Screenshots** of any error popups or UI issues

4. **Describe Steps to Reproduce** the issue

5. **Attach All Materials** when reporting the bug

## Technical Details

The console log export works by:

1. Overriding JavaScript's global `console.*` methods
2. Intercepting all console calls before they execute
3. Storing messages in a circular buffer (max 5000 entries)
4. Adding global error event listeners (`error`, `unhandledrejection`)
5. **Enhanced Error serialization** preserving non-enumerable properties
6. Formatting output as timestamped plain text

### Enhanced Error Serialization (v1.6.0.4)

The interceptor now properly captures Error objects with all properties:

**Captured Properties:**

- `message` - Error message
- `name` / `type` - Error type (TypeError, ReferenceError, etc.)
- `stack` - Complete stack trace with file paths and line numbers
- `fileName` - Source file where error occurred (Firefox-specific)
- `lineNumber` - Line number in source file (Firefox-specific)
- `columnNumber` - Column number in source file (Firefox-specific)
- `cause` - Chained error cause (if present)
- Any custom enumerable properties

**Before (v1.6.0.3 and earlier):**

```
[ERROR] [Copy Text] Failed: {"message":"e.querySelector is not a function","name":"TypeError"}
```

**After (v1.6.0.4+):**

```
[ERROR] [Copy Text] Failed: {
  "type": "TypeError",
  "message": "e.querySelector is not a function",
  "stack": "handler/t<@moz-extension://3f020ab4.../content.js:4279:23\nhandler@moz-extension://3f020ab4.../content.js:4286:10\nTe@moz-extension://3f020ab4.../content.js:4394:85",
  "fileName": "moz-extension://3f020ab4.../content.js",
  "lineNumber": 4279,
  "columnNumber": 23
}
```

### Why Some Errors Aren't Captured

Browser APIs like `browser.tabs.sendMessage()` log errors **directly to Browser Console** without going through JavaScript's `console` object. These errors are generated by Firefox's internal code and cannot be intercepted by overriding `console.*` methods.

**Example:**

```javascript
// This error is logged by Firefox internals, not JavaScript
browser.tabs.sendMessage(invalidTabId, {});
// Browser Console: "Could not establish connection. Receiving end does not exist."
// Exported logs: ❌ Not captured (browser-generated error)
```

## Workarounds

If you need to capture browser API errors in the export:

```javascript
try {
  await browser.tabs.sendMessage(tabId, message);
} catch (error) {
  console.error('[Browser API Error]', error); // ✅ Now captured in export
}
```

## Global Error Handlers (v1.6.0.4)

The interceptor now captures errors that don't go through `console.*`:

### Uncaught Exceptions

```javascript
// This will be captured even without try-catch
someUndefinedVariable.property;
// Exported logs: ✅ "[Uncaught Exception] someUndefinedVariable is not defined"
```

### Unhandled Promise Rejections

```javascript
// This will be captured even without .catch()
Promise.reject(new Error('Something failed'));
// Exported logs: ✅ "[Unhandled Promise Rejection] Error: Something failed"
```

## Testing the Feature

### Test Error Stack Traces

1. Open Browser Console (Ctrl+Shift+J)
2. Trigger an error in the extension
3. Export console logs
4. Verify exported file contains complete stack trace with file paths and line numbers

### Test Global Error Handler

1. Cause an uncaught exception (access undefined property)
2. Export console logs
3. Verify "[Uncaught Exception]" appears in exported file with full details

### Test Promise Rejection Capture

1. Create unhandled promise rejection
2. Export console logs
3. Verify "[Unhandled Promise Rejection]" appears in exported file

### Verify Browser API Limitation

1. Call browser.tabs.sendMessage on non-existent tab
2. Check Browser Console (should show error)
3. Export console logs (should NOT show that specific error)
4. This demonstrates documented limitation is working as expected

## References

### Mozilla Documentation

1. [runtime.lastError - MDN](https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/API/runtime/lastError) - Understanding browser-generated errors
2. [Error.prototype.stack - MDN](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Error/stack) - Non-enumerable error properties
3. [Browser Console - MDN](https://firefox-source-docs.mozilla.org/devtools-user/browser_console/index.html) - Multiple console contexts
4. [GlobalEventHandlers.onerror - MDN](https://developer.mozilla.org/en-US/docs/Web/API/GlobalEventHandlers/onerror) - Error event handling
5. [unhandledrejection event - MDN](https://developer.mozilla.org/en-US/docs/Web/API/Window/unhandledrejection_event) - Promise rejection handling

### Key Quotes

From MDN runtime.lastError documentation:

> "If lastError has been set and you don't check it within the callback function, then **an error will be raised**."

This explains why errors appear in Browser Console but aren't intercepted - they're raised by Firefox's internal code, not JavaScript's console object.

From MDN Error.stack documentation:

> "The non-standard stack property... **In Firefox, it's an accessor property** on Error.prototype."
> "Because the stack property is non-standard, **implementations differ** about where it's installed."

This explains why `JSON.stringify(error)` loses stack traces - it's a non-enumerable accessor property that requires special handling to serialize.

## Changelog

### v1.6.0.4 (Current)

- ✅ Enhanced Error object serialization preserving stack traces
- ✅ Added global error event handlers (uncaught exceptions, promise rejections)
- ✅ Complete file/line/column number capture
- ✅ Error causality chain support (`error.cause`)

### v1.6.0.3 and earlier

- ❌ Error stack traces lost during JSON serialization
- ❌ No global error event handlers
- ❌ Incomplete error information in exports

## Conclusion

The console log export feature now captures **comprehensive JavaScript-level diagnostic information** including complete stack traces and global errors. However, it has inherent limitations when capturing **browser-generated errors** that bypass JavaScript's console system.

For complete diagnostics, always provide:

1. ✅ Exported console logs (JavaScript errors with full stack traces)
2. ✅ Browser Console screenshots (browser-generated errors)
3. ✅ Steps to reproduce
