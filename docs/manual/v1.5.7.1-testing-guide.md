# Testing Guide for v1.5.7.1 - Promise-Based Save Queue Fix

## Overview

Version 1.5.7.1 fixes the critical "Quick Tab immediately closes" bug by implementing a promise-based save queue architecture as detailed in `promise-based-save-queue-architecture-v1.5.8.md`.

## What Changed

### Before (v1.5.7)
- Used `isSavingToStorage` flag with 100ms timeout
- Race condition: storage.onChanged could fire after timeout expired
- Result: Quick Tab would close immediately after creation

### After (v1.5.7.1)
- Promise-based SaveQueue with 50ms batching
- StateCoordinator in background maintains canonical state
- All saves confirmed via BATCH_QUICK_TAB_UPDATE message
- Eliminates ALL timeout-based race conditions

## Testing Procedures

### Test 1: Basic Quick Tab Creation (Critical)

**Objective**: Verify Quick Tab doesn't immediately close after creation

**Steps**:
1. Open a webpage (e.g., GitHub)
2. Hover over any link
3. Press 'Q' to create Quick Tab
4. **Expected**: Quick Tab appears and STAYS OPEN
5. **Expected**: Console shows `[SAVE QUEUE] Enqueued create for qt_...`
6. **Expected**: Console shows `[SAVE QUEUE] Batch save confirmed by background`

**Success Criteria**:
- ✅ Quick Tab remains visible
- ✅ No error messages in console
- ✅ Background console shows `[STATE COORDINATOR] Created Quick Tab qt_...`

---

### Test 2: Quick Tab Position Persistence

**Objective**: Verify position is saved and restored correctly

**Steps**:
1. Create a Quick Tab
2. Drag it to the top-left corner (approximately 100, 100)
3. Wait 2 seconds (for save queue to flush)
4. Reload the page (F5)
5. **Expected**: Quick Tab reappears at same position

**Success Criteria**:
- ✅ Position within 10px of original location
- ✅ Console shows `[SYNC] Creating Quick Tab qt_... from canonical state`

---

### Test 3: Rapid Quick Tab Creation (Batching)

**Objective**: Verify save queue batches multiple operations

**Steps**:
1. Open a page with multiple links
2. Quickly press 'Q' on 3 different links (within 1 second)
3. Check background console

**Expected Console Output**:
```
[SAVE QUEUE] Enqueued create for qt_1... (Queue size: 1)
[SAVE QUEUE] Enqueued create for qt_2... (Queue size: 2)
[SAVE QUEUE] Enqueued create for qt_3... (Queue size: 3)
[SAVE QUEUE] Flushing 3 operations to background
[STATE COORDINATOR] Processing 3 operations from tab 12345
[SAVE QUEUE] Batch save confirmed by background
```

**Success Criteria**:
- ✅ Only 1 batch message sent (not 3 separate messages)
- ✅ All 3 Quick Tabs created successfully
- ✅ Background console shows single "Processing 3 operations"

---

### Test 4: Drag Position Sync

**Objective**: Verify position updates are batched during drag

**Steps**:
1. Create a Quick Tab
2. Drag it slowly across the screen (5 seconds)
3. Check console during drag
4. Release mouse

**Expected Behavior**:
- During drag: Minimal console output (throttled saves)
- After release: `[SAVE QUEUE] Enqueued update for qt_...`
- After release: `Quick Tab qt_... position saved: (x, y)`

**Success Criteria**:
- ✅ Position updated in storage
- ✅ Not flooded with save messages during drag
- ✅ Final position saved correctly

---

### Test 5: Resize Sync

**Objective**: Verify size updates work correctly

**Steps**:
1. Create a Quick Tab
2. Grab bottom-right corner
3. Resize to approximately 800x600
4. Release mouse
5. Wait 2 seconds
6. Reload page

**Success Criteria**:
- ✅ Quick Tab restored at new size
- ✅ Console shows `Quick Tab qt_... resize saved: 800x600`

---

### Test 6: Cross-Tab Synchronization

**Objective**: Verify state syncs between tabs

**Steps**:
1. Open Tab A on github.com
2. Create Quick Tab in Tab A
3. Move it to position (200, 200)
4. Open Tab B on github.com (same origin)
5. **Expected**: Quick Tab appears in Tab B at (200, 200)
6. In Tab B: Move Quick Tab to (400, 400)
7. Switch back to Tab A
8. **Expected**: Quick Tab in Tab A updated to (400, 400)

**Success Criteria**:
- ✅ Quick Tab appears in new tab within 1 second
- ✅ Position updates propagate to other tabs
- ✅ Both tabs show `[SYNC] Received canonical state from coordinator`

---

### Test 7: Minimize and Restore

**Objective**: Verify minimize/restore operations save correctly

**Steps**:
1. Create a Quick Tab
2. Click minimize button
3. **Expected**: Quick Tab disappears, manager appears
4. **Expected**: Console shows `[SAVE QUEUE] Enqueued minimize for qt_...`
5. Reload page
6. **Expected**: Minimized manager appears with 1 tab
7. Click restore
8. **Expected**: Quick Tab reappears

**Success Criteria**:
- ✅ Minimized state persists across reload
- ✅ Restore brings Quick Tab back
- ✅ Console shows save queue messages

---

### Test 8: Container Integration (Firefox)

**Objective**: Verify container-aware state management still works

**Steps**:
1. Open Tab A in Personal container
2. Create Quick Tab
3. Switch to Work container tab
4. **Expected**: Quick Tab still visible (cross-container sync)
5. In Work container: Move Quick Tab to new position
6. Switch back to Personal container
7. **Expected**: Position updated

**Success Criteria**:
- ✅ Quick Tabs sync across containers
- ✅ State persists per container
- ✅ No errors in console

---

### Test 9: Multiple Quick Tabs

**Objective**: Verify multiple Quick Tabs can coexist

**Steps**:
1. Create 3 Quick Tabs on same page
2. Move each to different positions
3. Resize each to different sizes
4. Wait 2 seconds
5. Reload page

**Success Criteria**:
- ✅ All 3 Quick Tabs restored
- ✅ Correct positions maintained
- ✅ Correct sizes maintained
- ✅ Console shows `[STATE COORDINATOR] Initialized from sync storage: 3 tabs`

---

### Test 10: Error Handling

**Objective**: Verify graceful error handling

**Steps**:
1. Create a Quick Tab
2. Open browser console (Ctrl+Shift+J)
3. In background console, temporarily break the coordinator:
   ```javascript
   // Don't actually do this - just understand the concept
   ```
4. Try to create another Quick Tab
5. **Expected**: Error notification shown
6. **Expected**: Console shows `[SAVE QUEUE] Batch save failed: ...`

**Success Criteria**:
- ✅ Error message shown to user
- ✅ Extension doesn't crash
- ✅ Retry logic kicks in (check console)

---

## Console Output Reference

### Normal Operation (Content Script)

```
[SAVE QUEUE] Enqueued create for qt_1234567890_abc (Queue size: 1)
[SAVE QUEUE] Flushing 1 operations to background
[SAVE QUEUE] Batch save confirmed by background
Quick Tab qt_1234567890_abc creation saved and confirmed
[SYNC] Received canonical state from coordinator: 1 tabs
```

### Normal Operation (Background Script)

```
[STATE COORDINATOR] Processing 1 operations from tab 12345
[STATE COORDINATOR] Created Quick Tab qt_1234567890_abc
[STATE COORDINATOR] Persisted state to storage
[STATE COORDINATOR] Broadcasted state to 2 tabs
```

### Error Scenario

```
[SAVE QUEUE] Batch save failed: Error: ...
[SAVE QUEUE] Retrying failed saves...
Failed to save Quick Tab qt_...: Error: ...
```

---

## Performance Expectations

| Operation | Before (v1.5.7) | After (v1.5.7.1) |
|-----------|----------------|------------------|
| Quick Tab creation | 150-300ms | 50-150ms |
| Position update latency | 100-500ms | 50-150ms |
| Storage writes per action | 2-3 | 1 (batched) |
| Cross-tab sync delay | 200-800ms | <100ms |
| Success rate | ~80% | 100% |

---

## Known Issues (If Any)

None expected in v1.5.7.1 - this is a comprehensive fix.

---

## Debugging Tips

### Enable Debug Mode

1. Open extension settings
2. Check "Enable debug mode"
3. Reload page
4. Console will show detailed logs

### Background Console

1. Type `about:debugging` in Firefox address bar
2. Click "This Firefox"
3. Find "Copy URL on Hover Custom"
4. Click "Inspect" to open background console

### Check Storage State

In background console:
```javascript
// View current state
stateCoordinator.getState()

// Check if initialized
stateCoordinator.initialized
```

In content console:
```javascript
// View save queue size
saveQueue.size()

// View Quick Tab windows
quickTabWindows.length

// View minimized tabs
minimizedQuickTabs
```

---

## Rollback Plan

If issues are found:

1. Revert to v1.5.7:
   ```bash
   git checkout v1.5.7
   ```

2. Or apply emergency hotfix:
   - Increase timeout from 100ms to 500ms in old code
   - Release as v1.5.7.0.1

---

## Success Metrics

After testing, the fix is considered successful if:

1. ✅ 100% Quick Tab creation success rate (no immediate closes)
2. ✅ Position/size persistence works across reloads
3. ✅ Cross-tab sync latency < 200ms
4. ✅ No console errors during normal operation
5. ✅ Save queue batches rapid operations (< 3 storage writes for 10 creates)
6. ✅ Container integration still works correctly
7. ✅ Minimize/restore functionality intact

---

## Next Steps After Validation

1. If all tests pass → Merge to main → Release v1.5.7.1
2. Monitor user feedback for 1 week
3. If stable → Begin planning v1.5.8 (full architectural refactor)

---

**Document Version**: 1.0  
**Created**: 2025-11-12  
**Last Updated**: 2025-11-12  
**Related**: `promise-based-save-queue-architecture-v1.5.8.md`
