# Console Log Export Feature Implementation Guide
**copy-URL-on-hover Extension v1.5.8.16**

**Feature:** Export browser console logs from extension as downloadable .txt file  
**Repository:** ChunkyNosher/copy-URL-on-hover_ChunkyEdition  
**Date:** November 14, 2025, 3:24 PM EST

---

## Table of Contents

1. [Feature Overview](#feature-overview)
2. [Technical Implementation](#technical-implementation)
3. [File Structure Changes](#file-structure-changes)
4. [Code Implementation](#code-implementation)
5. [User Interface Integration](#user-interface-integration)
6. [Testing & Validation](#testing--validation)

---

## Feature Overview

### What This Feature Does

This feature adds the ability to **export all console logs generated by the extension** to a downloadable `.txt` file. The exported file includes:

- **Version number** (e.g., `v1.5.8.16`)
- **Export timestamp** in ISO 8601 format
- **All console logs** from the extension since page load
- **Organized by log type** (DEBUG, ERROR, WARN, INFO)

### Filename Format

```
copy-url-extension-logs_v1.5.8.16_2025-11-14T15-24-30.txt
```

**Pattern:**
```
copy-url-extension-logs_v{VERSION}_{TIMESTAMP}.txt
```

Where:
- `{VERSION}` = Extension version from `manifest.json`
- `{TIMESTAMP}` = ISO 8601 timestamp with colons replaced by hyphens for filename compatibility

### Why This Is Useful

1. **Debugging:** Users can easily share logs when reporting bugs
2. **Support:** Developers can analyze issues without asking users to copy/paste console output
3. **Documentation:** Logs can be archived for reproducibility
4. **Analysis:** Logs can be processed/searched offline

---

## Technical Implementation

### Architecture Overview

**Components:**

1. **Log Buffer System** (`src/utils/debug.js`)
   - Intercept all console.log calls
   - Store logs in memory array
   - Track log type, timestamp, and message

2. **Export Function** (`src/utils/debug.js`)
   - Format logs as plain text
   - Create Blob with text content
   - Generate download via Blob URL

3. **UI Trigger** (`popup.html` + `popup.js`)
   - Add "Export Logs" button to extension popup
   - Trigger export on click

4. **Background Communication** (`background.js`)
   - Collect logs from background script
   - Merge with content script logs

### APIs Used

- **Blob API** - Create downloadable file from text[142][148]
- **URL.createObjectURL()** - Generate downloadable URL[142][148]
- **browser.downloads.download()** - Alternative method (optional)[140][143]
- **browser.runtime.sendMessage()** - Communication between scripts

---

## File Structure Changes

### Files to Modify

```
copy-URL-on-hover_ChunkyEdition/
‚îú‚îÄ‚îÄ manifest.json                    # Add "downloads" permission (optional)
‚îú‚îÄ‚îÄ src/
‚îÇ   ‚îú‚îÄ‚îÄ utils/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ debug.js                 # Add log buffer & export function
‚îÇ   ‚îî‚îÄ‚îÄ content.js                   # Import export function
‚îú‚îÄ‚îÄ background.js                    # Add log collection
‚îú‚îÄ‚îÄ popup.html                       # Add export button UI
‚îî‚îÄ‚îÄ popup.js                         # Add export trigger
```

### New Dependencies

**None!** All functionality uses native Web APIs.

---

## Code Implementation

### Step 1: Update `manifest.json` (Optional)

**File:** `manifest.json`

Add the `downloads` permission to use `browser.downloads.download()` API (optional - we'll use Blob URL method as fallback):

```json
{
  "manifest_version": 2,
  "name": "Copy URL on Hover Custom",
  "version": "1.5.8.16",
  "permissions": [
    "storage",
    "tabs",
    "webRequest",
    "webRequestBlocking",
    "<all_urls>",
    "contextualIdentities",
    "cookies",
    "downloads"  // ‚Üê Add this (optional)
  ],
  // ... rest of manifest
}
```

**Note:** The `downloads` permission is **optional**. We'll implement both methods:
- **Method 1:** Blob URL + `<a>` download attribute (works without permission)
- **Method 2:** `browser.downloads.download()` API (requires permission, more reliable)

---

### Step 2: Enhance `src/utils/debug.js`

**File:** `src/utils/debug.js`

**Full replacement code:**

```javascript
/**
 * Debug Utilities with Log Export
 * Helper functions for debugging, logging, and exporting logs
 */

let DEBUG_MODE = false;

// Log buffer to store all logs
const LOG_BUFFER = [];
const MAX_BUFFER_SIZE = 5000; // Prevent memory overflow

/**
 * Log entry structure
 * @typedef {Object} LogEntry
 * @property {string} type - Log type (DEBUG, ERROR, WARN, INFO)
 * @property {number} timestamp - Unix timestamp
 * @property {string} message - Log message
 * @property {Array} args - Additional arguments
 */

/**
 * Add log entry to buffer
 * @param {string} type - Log type
 * @param {...any} args - Arguments to log
 */
function addToBuffer(type, ...args) {
  if (LOG_BUFFER.length >= MAX_BUFFER_SIZE) {
    // Remove oldest entry if buffer is full
    LOG_BUFFER.shift();
  }

  LOG_BUFFER.push({
    type: type,
    timestamp: Date.now(),
    message: args.map(arg =>
      typeof arg === 'object' ? JSON.stringify(arg, null, 2) : String(arg)
    ).join(' '),
    args: args
  });
}

/**
 * Enable debug mode
 */
export function enableDebug() {
  DEBUG_MODE = true;
  console.log('[DEBUG] Debug mode enabled');
}

/**
 * Disable debug mode
 */
export function disableDebug() {
  DEBUG_MODE = false;
  console.log('[DEBUG] Debug mode disabled');
}

/**
 * Check if debug mode is enabled
 * @returns {boolean} True if debug mode is enabled
 */
export function isDebugEnabled() {
  return DEBUG_MODE;
}

/**
 * Debug logging function
 * @param {...any} args - Arguments to log
 */
export function debug(...args) {
  addToBuffer('DEBUG', ...args);
  if (DEBUG_MODE) {
    console.log('[DEBUG]', ...args);
  }
}

/**
 * Error logging function
 * @param {...any} args - Arguments to log
 */
export function debugError(...args) {
  addToBuffer('ERROR', ...args);
  console.error('[ERROR]', ...args);
}

/**
 * Warning logging function
 * @param {...any} args - Arguments to log
 */
export function debugWarn(...args) {
  addToBuffer('WARN', ...args);
  if (DEBUG_MODE) {
    console.warn('[WARN]', ...args);
  }
}

/**
 * Info logging function
 * @param {...any} args - Arguments to log
 */
export function debugInfo(...args) {
  addToBuffer('INFO', ...args);
  console.info('[INFO]', ...args);
}

/**
 * Get all buffered logs
 * @returns {Array<LogEntry>} Array of log entries
 */
export function getLogBuffer() {
  return [...LOG_BUFFER]; // Return copy to prevent mutation
}

/**
 * Clear log buffer
 */
export function clearLogBuffer() {
  LOG_BUFFER.length = 0;
  console.log('[DEBUG] Log buffer cleared');
}

/**
 * Format logs as plain text
 * @param {Array<LogEntry>} logs - Array of log entries
 * @param {string} version - Extension version
 * @returns {string} Formatted log text
 */
export function formatLogsAsText(logs, version = '1.5.8.16') {
  const now = new Date();
  const header = [
    '=' .repeat(80),
    'Copy URL on Hover - Extension Console Logs',
    '=' .repeat(80),
    '',
    `Version: ${version}`,
    `Export Date: ${now.toISOString()}`,
    `Export Date (Local): ${now.toLocaleString()}`,
    `Total Logs: ${logs.length}`,
    '',
    '=' .repeat(80),
    ''
  ].join('\n');

  const logLines = logs.map(entry => {
    const date = new Date(entry.timestamp);
    const timestamp = date.toISOString();
    return `[${timestamp}] [${entry.type.padEnd(5)}] ${entry.message}`;
  });

  const footer = [
    '',
    '=' .repeat(80),
    'End of Logs',
    '=' .repeat(80)
  ].join('\n');

  return header + logLines.join('\n') + footer;
}

/**
 * Generate filename for log export
 * @param {string} version - Extension version
 * @returns {string} Filename with version and timestamp
 */
export function generateLogFilename(version = '1.5.8.16') {
  const now = new Date();
  // ISO 8601 format with hyphens instead of colons for filename compatibility
  const timestamp = now.toISOString().replace(/:/g, '-').split('.')[0];
  return `copy-url-extension-logs_v${version}_${timestamp}.txt`;
}

/**
 * Export logs as downloadable .txt file
 * @param {string} version - Extension version from manifest
 * @returns {Promise<void>}
 */
export async function exportLogs(version = '1.5.8.16') {
  try {
    // Get logs from current page
    const logs = getLogBuffer();

    // Try to get logs from background script
    try {
      const response = await browser.runtime.sendMessage({
        action: 'GET_BACKGROUND_LOGS'
      });
      if (response && response.logs) {
        logs.push(...response.logs);
      }
    } catch (error) {
      console.warn('[WARN] Could not retrieve background logs:', error);
    }

    // Sort logs by timestamp
    logs.sort((a, b) => a.timestamp - b.timestamp);

    // Format logs
    const logText = formatLogsAsText(logs, version);

    // Generate filename
    const filename = generateLogFilename(version);

    // Try Method 1: browser.downloads.download() API (if permission granted)
    if (typeof browser !== 'undefined' && browser.downloads && browser.downloads.download) {
      try {
        // Create blob
        const blob = new Blob([logText], { type: 'text/plain;charset=utf-8' });
        const url = URL.createObjectURL(blob);

        // Download via browser API
        await browser.downloads.download({
          url: url,
          filename: filename,
          saveAs: true
        });

        // Clean up
        setTimeout(() => URL.revokeObjectURL(url), 100);

        console.log('[INFO] Logs exported successfully via browser.downloads API');
        return;
      } catch (error) {
        console.warn('[WARN] browser.downloads failed, falling back to Blob URL:', error);
      }
    }

    // Method 2: Blob URL + <a> download attribute (fallback)
    const blob = new Blob([logText], { type: 'text/plain;charset=utf-8' });
    const blobUrl = URL.createObjectURL(blob);

    // Create temporary download link
    const link = document.createElement('a');
    link.href = blobUrl;
    link.download = filename;
    link.style.display = 'none';

    // Append to body (required for Firefox)
    document.body.appendChild(link);

    // Trigger download
    link.click();

    // Cleanup
    setTimeout(() => {
      document.body.removeChild(link);
      URL.revokeObjectURL(blobUrl);
    }, 100);

    console.log('[INFO] Logs exported successfully via Blob URL');
  } catch (error) {
    console.error('[ERROR] Failed to export logs:', error);
    throw error;
  }
}

/**
 * Generate a unique ID
 * @returns {string} Unique ID
 */
export function generateId() {
  return `${Date.now()}-${Math.random().toString(36).substring(2, 11)}`;
}

/**
 * Throttle function execution
 * @param {function} func - Function to throttle
 * @param {number} delay - Delay in milliseconds
 * @returns {function} Throttled function
 */
export function throttle(func, delay) {
  let lastCall = 0;
  return function (...args) {
    const now = Date.now();
    if (now - lastCall >= delay) {
      lastCall = now;
      return func.apply(this, args);
    }
  };
}

/**
 * Debounce function execution
 * @param {function} func - Function to debounce
 * @param {number} delay - Delay in milliseconds
 * @returns {function} Debounced function
 */
export function debounce(func, delay) {
  let timeoutId;
  return function (...args) {
    clearTimeout(timeoutId);
    timeoutId = setTimeout(() => func.apply(this, args), delay);
  };
}
```

---

### Step 3: Update `background.js`

**File:** `background.js`

**Add at the top of file:**

```javascript
// Log buffer for background script
const BACKGROUND_LOG_BUFFER = [];
const MAX_BACKGROUND_BUFFER_SIZE = 2000;

function addBackgroundLog(type, ...args) {
  if (BACKGROUND_LOG_BUFFER.length >= MAX_BACKGROUND_BUFFER_SIZE) {
    BACKGROUND_LOG_BUFFER.shift();
  }

  BACKGROUND_LOG_BUFFER.push({
    type: type,
    timestamp: Date.now(),
    message: args.map(arg =>
      typeof arg === 'object' ? JSON.stringify(arg, null, 2) : String(arg)
    ).join(' '),
    args: args
  });
}

// Override console methods to capture logs
const originalConsoleLog = console.log;
const originalConsoleError = console.error;
const originalConsoleWarn = console.warn;
const originalConsoleInfo = console.info;

console.log = function(...args) {
  addBackgroundLog('DEBUG', ...args);
  originalConsoleLog.apply(console, args);
};

console.error = function(...args) {
  addBackgroundLog('ERROR', ...args);
  originalConsoleError.apply(console, args);
};

console.warn = function(...args) {
  addBackgroundLog('WARN', ...args);
  originalConsoleWarn.apply(console, args);
};

console.info = function(...args) {
  addBackgroundLog('INFO', ...args);
  originalConsoleInfo.apply(console, args);
};
```

**Add message listener:**

```javascript
// Listen for log export requests from popup
browser.runtime.onMessage.addListener((message, sender, sendResponse) => {
  if (message.action === 'GET_BACKGROUND_LOGS') {
    sendResponse({ logs: [...BACKGROUND_LOG_BUFFER] });
    return true;
  }

  // ... existing message handlers
});
```

---

### Step 4: Update `popup.html`

**File:** `popup.html`

**Add Export Logs button in appropriate section:**

```html
<!-- Add this section near the bottom of the popup, before closing </body> -->

<div class="section">
  <h3>Debug & Logs</h3>
  <button id="export-logs-btn" class="btn-primary">
    üì• Export Console Logs
  </button>
  <p class="help-text">
    Download all extension console logs as a .txt file for debugging or support.
  </p>
</div>

<style>
.section {
  margin: 15px 0;
  padding: 10px;
  border-top: 1px solid #e0e0e0;
}

.btn-primary {
  background-color: #4CAF50;
  color: white;
  border: none;
  padding: 10px 20px;
  text-align: center;
  text-decoration: none;
  display: inline-block;
  font-size: 14px;
  cursor: pointer;
  border-radius: 4px;
  width: 100%;
}

.btn-primary:hover {
  background-color: #45a049;
}

.btn-primary:active {
  background-color: #3d8b40;
}

.help-text {
  font-size: 12px;
  color: #666;
  margin-top: 8px;
}
</style>
```

---

### Step 5: Update `popup.js`

**File:** `popup.js`

**Add at the top:**

```javascript
import { exportLogs } from './src/utils/debug.js';
```

**Add event listener (near other event listeners):**

```javascript
// Export logs button
document.getElementById('export-logs-btn').addEventListener('click', async () => {
  try {
    // Get version from manifest
    const manifest = browser.runtime.getManifest();
    const version = manifest.version;

    // Export logs
    await exportLogs(version);

    // Show success feedback
    const btn = document.getElementById('export-logs-btn');
    const originalText = btn.textContent;
    btn.textContent = '‚úì Logs Exported!';
    btn.style.backgroundColor = '#4CAF50';

    setTimeout(() => {
      btn.textContent = originalText;
      btn.style.backgroundColor = '';
    }, 2000);
  } catch (error) {
    console.error('[ERROR] Failed to export logs:', error);

    // Show error feedback
    const btn = document.getElementById('export-logs-btn');
    const originalText = btn.textContent;
    btn.textContent = '‚úó Export Failed';
    btn.style.backgroundColor = '#f44336';

    setTimeout(() => {
      btn.textContent = originalText;
      btn.style.backgroundColor = '';
    }, 2000);
  }
});
```

---

### Step 6: Update Build Configuration (if using rollup)

**File:** `rollup.config.js`

Ensure `debug.js` exports are included in the build:

```javascript
export default {
  input: 'src/content.js',
  output: {
    file: 'content.js',
    format: 'iife'
  },
  // ... existing config
};
```

If your build process requires it, you may need to explicitly export `exportLogs` from `src/utils/index.js`:

**File:** `src/utils/index.js`

```javascript
export * from './debug.js';
export * from './browser-api.js';
export * from './dom.js';
```

---

## User Interface Integration

### Where the Button Appears

The "Export Console Logs" button will appear in the **extension popup** when users click the extension icon in their browser toolbar.

### User Flow

1. User clicks extension icon ‚Üí popup opens
2. User scrolls to "Debug & Logs" section
3. User clicks "üì• Export Console Logs" button
4. Browser prompts for download location (if using `saveAs: true`)
5. File downloads with format: `copy-url-extension-logs_v1.5.8.16_2025-11-14T15-24-30.txt`
6. Button shows "‚úì Logs Exported!" feedback

### Example Log File Output

```
================================================================================
Copy URL on Hover - Extension Console Logs
================================================================================

Version: 1.5.8.16
Export Date: 2025-11-14T20:24:30.123Z
Export Date (Local): 11/14/2025, 3:24:30 PM
Total Logs: 47

================================================================================

[2025-11-14T20:22:15.456Z] [DEBUG] Creating Quick Tab for: https://example.com
[2025-11-14T20:22:15.489Z] [DEBUG] Saving Quick Tabs, saveId: 1731617735489-abc123, count: 1
[2025-11-14T20:22:15.501Z] [DEBUG] Save successful, saveId: 1731617735489-abc123
[2025-11-14T20:22:15.523Z] [INFO ] Quick Tab created successfully
[2025-11-14T20:22:18.789Z] [WARN ] Storage sync delay detected: 200ms
[2025-11-14T20:22:20.111Z] [ERROR] Failed to load iframe: NS_BINDING_ABORTED

================================================================================
End of Logs
================================================================================
```

---

## Testing & Validation

### Test 1: Basic Export Functionality

**Steps:**
1. Open extension popup
2. Click "Export Console Logs" button
3. Check that download starts
4. Open downloaded file

**Expected Results:**
- ‚úÖ File downloads with correct name format
- ‚úÖ File contains header with version and timestamp
- ‚úÖ File contains all recent console logs
- ‚úÖ Button shows "‚úì Logs Exported!" feedback
- ‚úÖ Logs are sorted chronologically

### Test 2: Filename Format Validation

**Steps:**
1. Export logs
2. Check filename

**Expected Format:**
```
copy-url-extension-logs_v1.5.8.16_2025-11-14T15-24-30.txt
```

**Validation:**
- ‚úÖ Prefix: `copy-url-extension-logs_`
- ‚úÖ Version: `v1.5.8.16` (matches manifest.json)
- ‚úÖ Timestamp: ISO 8601 with hyphens instead of colons
- ‚úÖ Extension: `.txt`

### Test 3: Log Buffer Size Limits

**Steps:**
1. Generate 6000+ console logs (more than MAX_BUFFER_SIZE)
2. Export logs
3. Check file size

**Expected Results:**
- ‚úÖ File contains maximum 5000 logs (from content script)
- ‚úÖ Oldest logs are discarded (FIFO)
- ‚úÖ No memory overflow

### Test 4: Background Script Logs

**Steps:**
1. Trigger background script actions (e.g., create Quick Tab)
2. Export logs
3. Check file contents

**Expected Results:**
- ‚úÖ File contains both content script and background script logs
- ‚úÖ Logs are merged and sorted by timestamp
- ‚úÖ Background logs clearly identifiable

### Test 5: Cross-Browser Compatibility

**Test in:**
- ‚úÖ Firefox 100+
- ‚úÖ Firefox ESR
- ‚úÖ Firefox Android (if applicable)

**Check:**
- ‚úÖ Blob URL download works
- ‚úÖ Filename format preserved
- ‚úÖ No console errors

### Test 6: Error Handling

**Scenarios:**
1. Export with empty log buffer
2. Export while downloads permission denied
3. Export during page unload

**Expected Results:**
- ‚úÖ Empty logs create valid file with header
- ‚úÖ Fallback to Blob URL if browser.downloads unavailable
- ‚úÖ Error feedback shown if export fails

---

## Advanced Features (Optional Enhancements)

### Enhancement 1: Filter Logs by Type

Add checkboxes to filter which log types to export:

```html
<div class="log-filters">
  <label><input type="checkbox" id="filter-debug" checked> DEBUG</label>
  <label><input type="checkbox" id="filter-error" checked> ERROR</label>
  <label><input type="checkbox" id="filter-warn" checked> WARN</label>
  <label><input type="checkbox" id="filter-info" checked> INFO</label>
</div>
```

Update `exportLogs()`:

```javascript
export async function exportLogs(version, filters = { DEBUG: true, ERROR: true, WARN: true, INFO: true }) {
  let logs = getLogBuffer();

  // Filter by type
  logs = logs.filter(log => filters[log.type]);

  // ... rest of export logic
}
```

### Enhancement 2: Auto-Export on Error

Automatically export logs when critical error occurs:

```javascript
export function debugError(...args) {
  addToBuffer('ERROR', ...args);
  console.error('[ERROR]', ...args);

  // Auto-export on critical errors
  if (args[0] && args[0].toString().includes('CRITICAL')) {
    exportLogs('1.5.8.16').catch(err =>
      console.error('Failed to auto-export logs:', err)
    );
  }
}
```

### Enhancement 3: Log Statistics

Add statistics section to exported logs:

```javascript
function getLogStats(logs) {
  const stats = {
    total: logs.length,
    byType: {},
    timespan: 0
  };

  logs.forEach(log => {
    stats.byType[log.type] = (stats.byType[log.type] || 0) + 1;
  });

  if (logs.length > 0) {
    stats.timespan = logs[logs.length - 1].timestamp - logs[0].timestamp;
  }

  return stats;
}
```

---

## References

**Blob API Documentation:**
- [MDN: Blob](https://developer.mozilla.org/en-US/docs/Web/API/Blob)
- [MDN: URL.createObjectURL()](https://developer.mozilla.org/en-US/docs/Web/API/URL/createObjectURL)

**Firefox Extensions API:**
- [MDN: browser.downloads.download()](https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/API/downloads/download)[140]
- [MDN: browser.runtime.sendMessage()](https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/API/runtime/sendMessage)

**Implementation Examples:**
- [Downloading Text Using Blobs (Ben Nadel)](https://www.bennadel.com/blog/3472-downloading-text-using-blobs-url-createobjecturl-and-the-anchor-download-attribute-in-javascript.htm)[148]
- [Download Any File from Blob (DEV Community)](https://dev.to/nombrekeff/download-file-from-blob-21ho)[142]

---

**END OF IMPLEMENTATION GUIDE**

This document provides complete, production-ready code for implementing console log export functionality in the copy-URL-on-hover extension v1.5.8.16.