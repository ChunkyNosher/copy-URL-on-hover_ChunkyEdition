{
  "id": "89889db1-c94a-45dc-872b-e5075752904f",
  "title": "Integration Test Initialization Pattern - Critical",
  "details": "## Critical Pattern: Proper Test Initialization for Cross-Tab Tests\n\n### Wrong Approach ❌\n```javascript\n// DON'T add Quick Tab to all state managers directly\nstateManagers.forEach(sm => sm.add(qt));\n\n// Then update local qt reference\nqt.updatePosition(left, top);\nbroadcastManagers[0].broadcast('UPDATE_POSITION', {...});\n```\n\n**Problem:** This bypasses the cross-tab synchronization mechanism and creates stale references.\n\n### Correct Approach ✅\n```javascript\n// 1. Add to Tab A only\nstateManagers[0].add(qt);\n\n// 2. Broadcast CREATE to synchronize with other tabs\nawait broadcastManagers[0].broadcast('CREATE', {\n  id: qt.id,\n  url: qt.url,\n  position: qt.position,\n  size: qt.size,\n  container: qt.container\n});\n\n// 3. Wait for cross-tab sync to complete\nawait wait(150); // Allows CREATE message to propagate\n\n// 4. Get fresh reference from Tab A's state\nconst qtInA = stateManagers[0].get(qt.id);\n\n// 5. Update local state before broadcasting\nqtInA.updatePosition(left, top);\nbroadcastManagers[0].broadcast('UPDATE_POSITION', {\n  id: qt.id,\n  position: { left, top },\n  container: qt.container\n});\n\n// 6. Respect debounce timing (60ms > 50ms debounce window)\nawait wait(60);\n```\n\n### Why This Matters\n\n1. **Realistic testing** - Tests actual cross-tab synchronization behavior\n2. **Fresh references** - Ensures each tab has its own QuickTab instance\n3. **State consistency** - Local state matches broadcast state\n4. **Debounce awareness** - Respects BroadcastManager's 50ms deduplication window\n\n### BroadcastManager Debounce Behavior\n\nBroadcastManager deduplicates messages with:\n- Same message type\n- Same Quick Tab ID  \n- Within 50ms window\n\n**Test accordingly:**\n- Use 60ms delays between same-type broadcasts\n- Don't rely on immediate propagation\n- Wait 150ms+ for CREATE messages to fully propagate\n\n### Files Using This Pattern\n\n- scenario-16-rapid-position-updates.test.js (all 9 tests passing)\n- scenario-07-position-size-persistence.test.js (all 11 tests passing)\n- scenario-11-emergency-save.test.js (all 7 tests passing)",
  "category": "best-practices",
  "dateCreated": "2025-11-23T18:27:21.846Z",
  "dateUpdated": "2025-11-23T18:27:21.846Z"
}