{
  "id": "7465e043-08eb-471d-b423-da1659fe3171",
  "title": "v1.6.4.16 State Persistence Fixes",
  "details": "# v1.6.4.16 State Persistence and Messaging Fixes\n\n## Summary\nImplemented three critical fixes for state persistence and messaging reliability in the Quick Tabs Manager extension.\n\n## Changes Made\n\n### Issue #9: Promise-based Listener Barrier\n**File:** sidebar/quick-tabs-manager.js\n**Lines:** 545-605 (new functions), ~820 (reset), ~863 (mark ready)\n\n**Changes:**\n- Replaced boolean `listenerFullyRegistered` with Promise-based barrier\n- Added `listenerReadyPromise`, `_listenerReadyResolve`, `_listenerReadyReject`\n- New functions:\n  - `_initListenerReadyPromise()` - Creates new promise barrier\n  - `_markListenerReady()` - Resolves promise and sets boolean (backward compat)\n  - `_resetListenerReadyState()` - Reset for reconnection\n  - `waitForListenerReady(timeoutMs)` - Async barrier with timeout\n- Boolean kept for backward compatibility (sync checks)\n- Promise used for async operations that need listener ready\n\n### Issue #13: Message Dedup Size-Based Eviction\n**File:** sidebar/quick-tabs-manager.js\n**Lines:** 166 (constant), ~1980-2020 (cleanup function), ~1960 (mark function)\n\n**Changes:**\n- Added `MESSAGE_DEDUP_MAX_SIZE = 1000` constant\n- Enhanced `_cleanupExpiredMessageIds()` with:\n  - LRU-style eviction when over max size\n  - Sorts by timestamp, evicts oldest entries\n  - Logs eviction events\n- Enhanced `_markMessageAsProcessed()` with:\n  - Proactive cleanup when at 90% capacity\n\n### Issue #11: Keepalive ACK Correlation ID Echo\n**File:** background.js\n**Lines:** 4850-4890 (handleHeartbeat function)\n\n**Changes:**\n- Modified `handleHeartbeat()` to extract `correlationId` and `messageSequence` from message\n- Echo `correlationId` back in HEARTBEAT_ACK response\n- Enhanced logging to include correlationId and messageSequence\n\n## Issues Already Implemented (No Changes Needed)\n- Issue #1: Port Connection - `connectToBackground()` with circuit breaker\n- Issue #2: BroadcastChannel - `initializeBroadcastChannel()` with fallback modes\n- Issue #3: Storage Event Ordering - `_validateSequenceId()` exists\n- Issue #4: Port Message Reordering - `_handlePortMessageWithQueue()` exists\n- Issue #8: Comprehensive Logging - Extensive logging with prefixes\n- Issue #10: DOMContentLoaded - Listeners wrapped in DOMContentLoaded\n- Issue #12: Storage Watchdog - `_handleWatchdogTimeout()` exists\n- Issue #14: BC Stale Detection - `isBroadcastChannelStale()` with gap detection\n\n## Key Patterns Introduced\n1. Promise barrier pattern for async synchronization\n2. LRU eviction for bounded collections\n3. Correlation ID echo for request-response matching\n\n## Testing\n- All 1645 Jest tests pass\n- ESLint: 0 errors, 14 warnings (pre-existing)",
  "category": "implementation",
  "dateCreated": "2025-12-10T23:59:31.930Z",
  "dateUpdated": "2025-12-10T23:59:31.930Z"
}
