{
  "id": "bb4c1995-b169-43d0-a57d-20a14a9377ed",
  "title": "v1.6.3.6-v2 Storage Loop Fixes",
  "details": "## Storage Write Loop Fix (v1.6.3.6-v2)\n\nThree interconnected critical bugs fixed:\n\n### Issue 1: Self-Write Detection Strengthened\n- WRITING_INSTANCE_ID now uses triple entropy: performance.now() + Math.random() + crypto + writeCounter\n- Added `lastWrittenTransactionId` tracking for deterministic self-write detection\n- Transaction IDs include writeCounter for uniqueness within same millisecond\n- Extracted helper functions: `_isMatchingTransactionId()`, `_isMatchingInstanceId()`, `_isMatchingTabId()`\n\n### Issue 2: Loop Detection Logging Added\n- `queueStorageWrite()` logs warnings when pendingWriteCount > 5 (Warning) or > 10 (Critical)\n- `_trackDuplicateSaveIdWrite()` detects if same saveId written >2 times in 1000ms\n- Transaction timeout changed from `console.warn` to `console.error` with explicit loop warning\n- New constants: DUPLICATE_SAVEID_WINDOW_MS = 1000, DUPLICATE_SAVEID_THRESHOLD = 2\n\n### Issue 3: Empty State Corruption Fixed\n- Removed `tabs.length === 0` bypass from `validateOwnershipForWrite()`\n- Added `previouslyOwnedTabIds` Set for ownership history tracking\n- Empty writes now require: `forceEmpty=true` AND tab has ownership history\n- Added `forceEmpty` parameter to `validateOwnershipForWrite(tabs, currentTabId, forceEmpty)`\n- Extracted helpers: `_filterOwnedTabs()`, `_logOwnershipFiltering()`, `_handleEmptyWriteValidation()`\n\n### Background.js Changes\n- Removed problematic `_isSpuriousFirefoxEvent()` check that caused false negatives\n- Simplified `_shouldIgnoreStorageChange()` to only check transaction ID\n- Replaced `_isAnySelfWrite()` with simpler `_isTransactionSelfWrite()`\n- Content scripts handle self-write detection via `isSelfWrite()` - background just updates cache\n\n### Key Architecture Points\n- Self-write detection is now three-layered: transactionId → instanceId → tabId\n- Storage writes always include writingInstanceId and writingTabId for detection\n- Ownership validation passes forceEmpty through the chain for proper empty write handling",
  "category": "technical_patterns",
  "dateCreated": "2025-12-05T07:02:45.218Z",
  "dateUpdated": "2025-12-05T07:02:45.218Z"
}