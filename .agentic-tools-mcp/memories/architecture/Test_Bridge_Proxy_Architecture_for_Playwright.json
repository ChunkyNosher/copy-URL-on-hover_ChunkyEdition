{
  "id": "c5ca88b6-d361-47a7-8748-82471a2a60c6",
  "title": "Test Bridge Proxy Architecture for Playwright",
  "details": "The test bridge for Playwright testing uses a 3-layer message passing architecture to enable page context access to extension APIs.\n\n**Problem**: Playwright tests run in regular web page contexts (e.g., example.com), but the test bridge API is in the extension background script. Pages cannot directly access extension background scripts due to browser security restrictions.\n\n**Solution**: 3-layer proxy architecture using custom events and browser.runtime.sendMessage\n\n**Architecture**:\n1. **Page Context** (`window.__COPILOT_TEST_BRIDGE__`):\n   - File: `src/test-bridge-page-proxy.js`\n   - Injected into page via script element from content script\n   - Provides async methods that dispatch custom events\n\n2. **Content Script** (test-bridge-content-handler.js):\n   - File: `src/test-bridge-content-handler.js`\n   - Listens for TEST_BRIDGE_REQUEST custom events from page\n   - Forwards to background via browser.runtime.sendMessage\n   - Receives responses and dispatches TEST_BRIDGE_RESPONSE events\n\n3. **Background Script** (test-bridge-background-handler.js):\n   - File: `src/test-bridge-background-handler.js`\n   - Listens for TEST_BRIDGE_CALL messages\n   - Routes to appropriate test bridge method\n   - Returns results via sendResponse\n\n**Build Process**:\n- Script: `scripts/inject-test-bridge.cjs`\n- Runs during `npm run build:test` when TEST_MODE=true\n- Injects page proxy into dist/content.js\n- Injects content handler into dist/content.js\n- Injects background handler into dist/background.js\n- Injects test bridge API into dist/background.js\n\n**Usage in Tests**:\n```javascript\nconst helper = new ExtensionTestHelper(page);\nawait helper.waitForTestBridge(15000); // Waits for proxy availability\nawait helper.createQuickTab('https://github.com'); // Uses page proxy\nconst tabs = await helper.getQuickTabs(); // Returns data from storage\n```\n\n**Message Flow**:\n```\nTest → helper.createQuickTab()\n  → window.__COPILOT_TEST_BRIDGE__.createQuickTab()\n    → CustomEvent('TEST_BRIDGE_REQUEST')\n      → content handler listens\n        → browser.runtime.sendMessage({type: 'TEST_BRIDGE_CALL'})\n          → background handler listens\n            → window.__COPILOT_TEST_BRIDGE__.createQuickTab()\n              → returns result\n            → sendResponse({success: true, data})\n          → content handler receives\n        → CustomEvent('TEST_BRIDGE_RESPONSE')\n      → page proxy resolves promise\n    → returns to test\n  → test continues\n```\n\n**Key Files**:\n- src/test-bridge-page-proxy.js - Page context bridge\n- src/test-bridge-content-handler.js - Content script forwarder\n- src/test-bridge-background-handler.js - Background message router\n- src/test-bridge.js - Core test bridge API\n- scripts/inject-test-bridge.cjs - Build injection script",
  "category": "architecture",
  "dateCreated": "2025-11-22T23:05:37.264Z",
  "dateUpdated": "2025-11-22T23:05:37.264Z"
}