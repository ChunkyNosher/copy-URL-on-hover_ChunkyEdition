{
  "id": "152e2f7b-6a27-4069-bd5b-ddcb386c5842",
  "title": "Promise Export Pattern for Async Module Init",
  "content": "## Promise Export Pattern for Browser Extension Async Module Initialization\n\n### Problem Solved\nRace condition in async filter settings initialization where early logs used stale/null cache instead of user settings from browser.storage.local.\n\n### Architectural Pattern: Promise Export with IIFE\n\n```javascript\n// Export a promise that resolves when initialization completes\nexport const settingsReady = (async () => {\n  try {\n    // Add timeout protection (5s) for storage I/O\n    const storagePromise = browser.storage.local.get(['settings']);\n    const timeoutPromise = new Promise((_, reject) =>\n      setTimeout(() => reject(new Error('Timeout')), 5000)\n    );\n    \n    const result = await Promise.race([storagePromise, timeoutPromise]);\n    \n    // Atomic batch update to prevent partial reads\n    const newSettings = result.settings || getDefaults();\n    cache = newSettings;\n    \n    return { success: true, source: 'storage' };\n  } catch (error) {\n    cache = getDefaults(); // Always use safe fallback\n    return { success: false, source: 'defaults-error', error: error.message };\n  }\n})();\n```\n\n### Key Benefits\n1. **Graceful degradation**: Cache initialized with defaults immediately (never null)\n2. **Explicit async control**: Consumers can await settingsReady or proceed with defaults\n3. **Timeout protection**: Prevents hanging on slow storage I/O\n4. **Status reporting**: Returns object indicating success/source for debugging\n5. **Always resolves**: Never rejects, ensuring extension functions with defaults\n\n### Usage Pattern\n```javascript\n// Consumer that needs settings loaded\nawait settingsReady; // Waits for storage load\nconsole.log('Settings ready');\n\n// Consumer that works with defaults\n// No await needed - functions immediately with defaults\nif (isCategoryEnabled('hover')) { ... }\n```\n\n### Why Not Top-Level Await?\n- Rollup bundles to IIFE format which doesn't support top-level await\n- Would block entire extension initialization on storage I/O\n- Promise Export allows selective awaiting by consumers\n\n### Files Affected\n- src/utils/filter-settings.js - Exports settingsReady promise\n- src/utils/console-interceptor.js - Logs status after await\n- src/content.js - Awaits before extension initialization\n\n### References\nPerplexity research on ES module async initialization patterns\nMozilla Web Extensions API async storage patterns",
  "metadata": {},
  "createdAt": "2025-11-22T05:28:16.941Z",
  "updatedAt": "2025-11-22T05:28:16.941Z",
  "category": "architecture"
}
