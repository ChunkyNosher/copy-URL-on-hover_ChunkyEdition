{
  "id": "36dc72fd-80a2-4c91-9fda-50bfaf85e3c2",
  "title": "Playwright Extensions Require Persistent Context",
  "content": "CRITICAL FINDING: Browser extensions in Playwright ONLY work with launchPersistentContext. There is no workaround using browser.launch() + newContext().\n\n**Research Confirmed By**:\n- Playwright Official Documentation (playwright.dev/docs/chrome-extensions)\n- Playwright GitHub Issues (#13918, #11108, #28292)\n- Multiple developer blogs and guides\n\n**Why This Limitation Exists**:\nExtensions require a persistent context that maintains state across the browser's entire lifetime. The --load-extension argument only works when launching a persistent context because:\n1. Extensions need access to browser-level APIs\n2. Extension loading mechanism is tied to the persistent context implementation\n3. Regular contexts (browser.newContext()) are isolated and cannot load extensions\n\n**Failed Approach That Doesn't Work**:\n```javascript\n// ❌ DOES NOT WORK - Extensions won't load\nconst browser = await chromium.launch({\n  args: ['--load-extension=/path/to/extension']\n});\nconst context = await browser.newContext();\n```\n\n**Required Approach**:\n```javascript\n// ✅ REQUIRED - Only way to load extensions\nconst context = await chromium.launchPersistentContext(userDataDir, {\n  args: [\n    '--disable-extensions-except=/path/to/extension',\n    '--load-extension=/path/to/extension'\n  ]\n});\n```\n\n**Teardown Optimization Strategies** (to minimize worker timeout):\n\n1. **Hard 5-Second Timeout** (most important):\n```javascript\nawait Promise.race([\n  context.close(),\n  new Promise((_, reject) => \n    setTimeout(() => reject(new Error('Timeout')), 5000)\n  )\n]).catch(() => {}); // Don't throw - let worker clean up\n```\n\n2. **Disable Background Extensions**:\n```javascript\nargs: [\n  '--disable-component-extensions-with-background-pages',\n  '--disable-default-apps'\n]\n```\n\n3. **Close Pages in Parallel**:\n```javascript\nconst pages = context.pages();\nawait Promise.all(pages.map(page => page.close().catch(() => {})));\n```\n\n4. **Use Unique Temp Directories**:\n```javascript\nconst tmpDir = fs.mkdtempSync('/tmp/playwright-');\nawait chromium.launchPersistentContext(tmpDir, ...);\n```\n\n5. **Reuse Context Across Tests** (optional):\n```javascript\n// Share one persistent context across all tests in a worker\nlet sharedContext = null;\ntest.beforeAll(async () => {\n  sharedContext = await chromium.launchPersistentContext(...);\n});\ntest.afterAll(async () => {\n  await sharedContext?.close();\n});\n```\n\n**Why Teardown Is Slow**:\n- Persistent contexts write browser profile data to disk\n- Service workers (especially with Manifest V2) don't terminate quickly\n- Extension cleanup processes can take 10-30+ seconds\n- This is expected behavior, not a bug\n\n**Best Practices**:\n1. Accept that persistent contexts are required\n2. Use aggressive 5-second timeout on close\n3. Don't throw on cleanup errors\n4. Run tests serially (workers: 1) to reduce resource contention\n5. Consider Manifest V3 migration for non-persistent service workers\n\n**Alternative Solutions**:\n- None for automated testing - persistent context is the only option\n- Manual testing with loaded extension\n- Wait for Playwright to add non-persistent extension support (no ETA)\n\n**Key Takeaway**: Any attempt to avoid launchPersistentContext for extension testing is futile. The workaround is to optimize the persistent context cleanup process, not to avoid persistent contexts entirely.",
  "metadata": {},
  "createdAt": "2025-11-23T00:22:20.984Z",
  "updatedAt": "2025-11-23T00:22:20.984Z",
  "category": "architecture"
}
