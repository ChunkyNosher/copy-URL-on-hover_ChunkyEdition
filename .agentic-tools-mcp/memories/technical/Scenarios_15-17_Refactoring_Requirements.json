{
  "id": "61e8596d-8a0e-4962-be1c-590577b9269d",
  "title": "Scenarios 15-17 Refactoring Requirements",
  "details": "## API Refactoring Needed for Scenarios 15, 16, 17\n\n### Current Issues\nAll three scenarios use incorrect API patterns:\n1. **`bm.on()` doesn't exist** - Should use `eventBuses[i].on('broadcast:received', ...)`\n2. **`stateManagers[i].remove()` doesn't exist** - Should use `.delete()`\n3. **`stateManagers[i].getCount()` doesn't exist** - Should use `.count()`\n\n### Required Changes\n\n**1. Add EventEmitter infrastructure:**\n```javascript\nimport { EventEmitter } from 'eventemitter3';\nimport { createMultiTabScenario } from '../../helpers/cross-tab-simulator.js';\n\nlet tabs, eventBuses, channels;\n\nbeforeEach(async () => {\n  tabs = await createMultiTabScenario([...]);\n  eventBuses = tabs.map(() => new EventEmitter());\n  channels = tabs.map(() => ({ postMessage: jest.fn(), close: jest.fn(), onmessage: null }));\n  \n  // Mock BroadcastChannel\n  let channelIndex = 0;\n  global.BroadcastChannel = jest.fn(() => channels[channelIndex++]);\n  \n  // Create managers with eventBuses\n  broadcastManagers = tabs.map((tab, index) => {\n    const manager = new BroadcastManager(eventBuses[index], tab.containerId);\n    manager.setupBroadcastChannel();\n    return manager;\n  });\n  \n  stateManagers = tabs.map((tab, index) => {\n    return new StateManager(eventBuses[index], tab.tabId);\n  });\n  \n  // Connect channels for cross-tab delivery\n  channels.forEach((sourceChannel, sourceIndex) => {\n    sourceChannel.postMessage = jest.fn((message) => {\n      setTimeout(() => {\n        channels.forEach((targetChannel, targetIndex) => {\n          if (sourceIndex !== targetIndex && targetChannel.onmessage) {\n            targetChannel.onmessage({ data: message });\n          }\n        });\n      }, 10);\n    });\n  });\n  \n  // Setup broadcast handlers\n  eventBuses.forEach((bus, index) => {\n    bus.on('broadcast:received', (message) => {\n      if (message.type === 'DESTROY') { // or UPDATE_POSITION, etc.\n        // Handle message\n      }\n    });\n  });\n});\n```\n\n**2. Replace API calls:**\n- `stateManagers[i].remove(id)` → `stateManagers[i].delete(id)`\n- `stateManagers[i].getCount()` → `stateManagers[i].count()`\n\n**3. Handle local + broadcast pattern:**\nWhen initiating action locally:\n```javascript\n// Delete locally first\nstateManagers[0].delete(qt.id);\n// Then broadcast to others\nawait broadcastManagers[0].broadcast('DESTROY', { id: qt.id });\n```\n\n### Progress\n- Scenario 15: Partially refactored (EventEmitter added, API calls fixed, 1 test passing)\n- Scenario 16: Not started (11 tests failing)\n- Scenario 17: Not started (10 tests failing)\n\n### Estimated Effort\n- Scenario 15: ~1 hour (partially done)\n- Scenario 16: ~1 hour\n- Scenario 17: ~1.5 hours (largest file)",
  "category": "technical",
  "dateCreated": "2025-11-23T18:11:17.850Z",
  "dateUpdated": "2025-11-23T18:11:17.850Z"
}