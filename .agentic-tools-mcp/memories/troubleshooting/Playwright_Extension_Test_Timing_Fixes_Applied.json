{
  "id": "4ab6db10-dc9d-4448-bedf-451316b0f836",
  "title": "Playwright Extension Test Timing Fixes Applied",
  "content": "Extensive timing fixes implemented for Playwright browser extension testing based on multiple research sessions (Context7 + 3 Perplexity iterations).\n\n**Problem**: Test bridge injection timing issues and worker teardown timeouts when running browser extension tests with Playwright.\n\n**Root Causes Identified**:\n1. Content script injection timing - race condition between page load and script execution\n2. DOM readiness - elements may not exist when trying to inject at document_start\n3. Worker teardown - persistent browser contexts with extensions take long to clean up\n4. Resource contention - multiple workers overwhelm system with headed browser + extension\n\n**Solutions Implemented**:\n\n1. **Content Script Timing** (manifest.json):\n   - Changed from document_start to document_end (more reliable)\n   - Added DOM readiness check before injection\n   - Wraps injection in: if (document.readyState === 'loading') { addEventListener } else { inject immediately }\n\n2. **Test Bridge Waiting** (extension-test-utils.js):\n   - Changed from Node.js polling to in-page Promise-based polling\n   - Reduced polling interval from 100ms to 50ms (2x faster detection)\n   - Added comprehensive diagnostic logging on failure\n   - Better error messages showing window state\n\n3. **Browser Context Cleanup** (fixtures.js):\n   - Use unique temp directory for each test: `fs.mkdtempSync(path.join('/tmp', 'playwright-chrome-'))`\n   - Add force-close fallback with runBeforeUnload: false\n   - Proper error handling and logging for cleanup failures\n\n4. **Timeout Configuration** (playwright.config.chrome.js):\n   - Increased test timeout from 60s to 90s\n   - Added global timeout of 5 minutes\n   - Force workers: 1 (always single worker for extension tests)\n\n**Research Sources**:\n- Context7: Playwright CRX documentation (/ruifigueira/playwright-crx)\n- Perplexity Research Session 1: Content script timing and injection patterns\n- Perplexity Research Session 2: document_start vs document_end best practices  \n- Perplexity Research Session 3: Worker teardown timeout causes and solutions\n\n**Key Learnings**:\n- document_start is too early - DOM elements may not exist yet\n- document_end + readiness check is most reliable pattern\n- Persistent contexts with extensions need unique temp directories\n- Worker teardown timeout is separate from test timeout\n- Single worker is essential for extension tests (resource intensive)\n\n**Remaining Challenge**:\nWorker teardown timeout still occurs even with fixes. This is because:\n- Persistent browser contexts write real profiles to disk\n- Extension background pages are persistent processes (Manifest V2)\n- Cleanup must wait for all browser processes to fully terminate\n- Can take 10-30+ seconds even with force-close\n\n**Possible Future Solutions**:\n1. Use non-persistent context with manual extension loading (more complex)\n2. Migrate to Manifest V3 (non-persistent service worker background)\n3. Accept longer teardown times and increase timeout further\n4. Use different launch strategy (regular context + devtools protocol extension loading)\n\n**Files Modified**:\n- manifest.json (run_at timing)\n- scripts/inject-test-bridge.cjs (DOM readiness wrapper)\n- tests/extension/helpers/extension-test-utils.js (improved polling)\n- src/test-bridge-page-proxy.js (ready event)\n- tests/extension/fixtures.js (cleanup improvements)\n- playwright.config.chrome.js (timeouts and workers)\n\n**Result**: Test bridge architecture is production-ready and timing-resilient. Worker teardown remains a known limitation of Playwright + persistent contexts + extensions + headed mode combination.",
  "metadata": {},
  "createdAt": "2025-11-22T23:37:50.197Z",
  "updatedAt": "2025-11-22T23:37:50.197Z",
  "category": "troubleshooting"
}
