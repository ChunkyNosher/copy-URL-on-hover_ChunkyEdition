{
  "id": "c0749b4b-c5b6-43f1-a673-6c74c5866b2a",
  "title": "Scenario 7 Storage Mock Fix - Critical Pattern",
  "details": "## Critical Storage Mocking Pattern for Integration Tests\n\n### Issue Discovered\nIntegration tests were failing because storage mocks were set up incorrectly:\n\n1. **Wrong browser object**: Tests mocked `global.browser` but source code imports `browser` from `'webextension-polyfill'` (different objects)\n2. **Wrong return structure**: `browser.storage.local.get(key)` must return `{ [key]: value }`, not value directly\n\n### Correct Pattern\n```javascript\n// Import the actual browser object that source code uses\nconst browserModule = await import('webextension-polyfill');\nconst browser = browserModule.default;\n\n// Mock with proper return structure\nbrowser.storage.local.get = jest.fn().mockImplementation((key) => {\n  if (typeof key === 'string') {\n    return Promise.resolve({ [key]: mockStorage[key] }); // âœ… Correct\n  }\n  return Promise.resolve(mockStorage);\n});\n\nbrowser.storage.local.set = jest.fn().mockImplementation((data) => {\n  Object.assign(mockStorage, data);\n  return Promise.resolve();\n});\n\n// Set global.browser for code that uses global browser API\nglobal.browser = browser;\n```\n\n### BroadcastManager Debouncing\nBroadcastManager debounces duplicate message types (same type+ID) within 50ms. Tests must wait >50ms between broadcasts of same type.\n\n### Test Pattern for Close/Destroy\nWhen a tab initiates a close/destroy action:\n1. Delete from local state first: `stateManagers[0].delete(id)`\n2. Then broadcast to others: `broadcastManagers[0].broadcast('DESTROY', { id })`\n\nBroadcasts don't send to sender, only to other tabs.",
  "category": "troubleshooting",
  "dateCreated": "2025-11-23T18:10:29.375Z",
  "dateUpdated": "2025-11-23T18:10:29.375Z"
}