name: Sync Agent Memory on PR Merge

on:
  pull_request:
    types: [closed]
    branches:
      - main

permissions:
  contents: write

jobs:
  sync-memory:
    # Only run if PR was merged and came from copilot
    if: |
      github.event.pull_request.merged == true &&
      startsWith(github.event.pull_request.head.ref, 'copilot/')
    runs-on: ubuntu-latest
    steps:
      - name: Checkout main branch
        uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 2

      - name: Verify memory files exist in merge
        run: |
          echo "=========================================="
          echo "Checking for Agent Memory in Merged PR"
          echo "=========================================="

          # Check if agentic-tools-mcp directory exists
          if [ -d ".agentic-tools-mcp" ]; then
            echo "âœ“ .agentic-tools-mcp/ directory found"
            echo ""
            
            # Count memory files (individual JSON files in subdirectories)
            if [ -d ".agentic-tools-mcp/memories" ]; then
              MEMORY_COUNT=$(find .agentic-tools-mcp/memories -name "*.json" 2>/dev/null | wc -l)
              echo "  Memory files: $MEMORY_COUNT"
              if [ $MEMORY_COUNT -gt 0 ]; then
                echo "  Categories:"
                ls -d .agentic-tools-mcp/memories/*/ 2>/dev/null | xargs -n1 basename
                echo ""
                echo "  Latest memory files:"
                find .agentic-tools-mcp/memories -name "*.json" -type f -exec ls -lth {} + | head -3
              fi
            else
              echo "  Memory files: 0 (directory doesn't exist)"
            fi
            
            echo ""
            
            # Count task data
            if [ -f ".agentic-tools-mcp/tasks/tasks.json" ]; then
              TASK_COUNT=$(cat .agentic-tools-mcp/tasks/tasks.json | jq '.tasks | length' 2>/dev/null || echo "0")
              echo "  Task count: $TASK_COUNT"
            else
              echo "  Task count: 0 (tasks.json doesn't exist)"
            fi
            
            echo ""
            ls -la .agentic-tools-mcp/
          else
            echo "âš ï¸ .agentic-tools-mcp/ directory not found"
            echo "Agent may not have committed memory files"
          fi

          echo "=========================================="

      - name: Create memory verification comment
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const path = require('path');
            const { execSync } = require('child_process');

            let message = '## ğŸ§  Agent Memory Sync Status\n\n';

            const hasAgenticTools = fs.existsSync('.agentic-tools-mcp');

            if (hasAgenticTools) {
              message += 'âœ… Memory files successfully persisted to main branch\n\n';
              
              // Count individual memory JSON files
              let memoryCount = 0;
              const memoriesDir = '.agentic-tools-mcp/memories';
              if (fs.existsSync(memoriesDir)) {
                try {
                  const result = execSync(`find ${memoriesDir} -name "*.json" | wc -l`).toString().trim();
                  memoryCount = parseInt(result) || 0;
                } catch (e) {
                  memoryCount = 0;
                }
              }
              
              // Count tasks
              let taskCount = 0;
              const tasksFile = '.agentic-tools-mcp/tasks/tasks.json';
              if (fs.existsSync(tasksFile)) {
                try {
                  const tasksData = JSON.parse(fs.readFileSync(tasksFile, 'utf8'));
                  taskCount = tasksData.tasks?.length || 0;
                } catch (e) {
                  taskCount = 0;
                }
              }
              
              message += `### ğŸ“Š Summary\n\n`;
              message += `- âœ“ Agentic-Tools directory: **present**\n`;
              message += `- âœ“ Memory files: **${memoryCount}** individual JSON files\n`;
              message += `- âœ“ Tasks: **${taskCount}**\n\n`;
              
              if (memoryCount > 0) {
                message += '### ğŸ“ Memory Files Structure\n\n';
                message += 'Memories are stored as individual JSON files organized by category:\n';
                message += '```\n';
                message += '.agentic-tools-mcp/memories/\n';
                message += '  â”œâ”€â”€ preferences/\n';
                message += '  â”œâ”€â”€ technical/\n';
                message += '  â””â”€â”€ context/\n';
                message += '```\n\n';
              }
              
              if (memoryCount > 0 || taskCount > 0) {
                message += '**Agent successfully persisted learnings from this PR!** ğŸ‰';
              } else {
                message += '**Note:** Directory exists but no memory/task files yet (this may be expected for the first PR).';
              }
            } else {
              message += 'âš ï¸ Memory files missing:\n\n';
              message += `- âŒ Agentic-Tools directory not found\n\n`;
              message += '**Action Required:** Check if Copilot committed `.agentic-tools-mcp/` directory in this PR.\n\n';
              message += '### Expected Structure\n\n';
              message += 'Copilot should create:\n';
              message += '```\n';
              message += '.agentic-tools-mcp/\n';
              message += '  â”œâ”€â”€ memories/          # Individual JSON files per memory\n';
              message += '  â”‚   â”œâ”€â”€ preferences/\n';
              message += '  â”‚   â”œâ”€â”€ technical/\n';
              message += '  â”‚   â””â”€â”€ context/\n';
              message += '  â””â”€â”€ tasks/\n';
              message += '      â””â”€â”€ tasks.json     # Task data\n';
              message += '```\n\n';
              message += 'Copilot must run: `git add .agentic-tools-mcp/` before final commit.';
            }

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.pull_request.number,
              body: message
            });
